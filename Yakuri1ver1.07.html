<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薬理学クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">

    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>

    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
    <style>
        body {
            /* Corrected font-family: removed '%' */
            font-family: 'Noto+Sans+JP', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            text-align: center;
        }
        @media (min-width: 640px) {
            .container {
                padding: 2rem;
            }
        }
        #quiz-card-element {
            background-color: white;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            padding: 1.5rem;
            margin-bottom: 2rem;
            overflow: hidden; 
            position: relative; 
        }
         @media (min-width: 640px) {
            #quiz-card-element {
                padding: 2rem;
            }
        }
        #quiz-card-content {
            width: 100%;
            transition: transform 0.35s ease-in-out, opacity 0.35s ease-in-out;
            will-change: transform, opacity; 
        }

        #quiz-container {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; 
        }
        #quiz-container.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s; 
        }

        .question {
            font-size: 1.05rem; 
            margin-bottom: 1.5rem;
            color: #1f2937; 
            font-weight: 500; 
            text-align: left;
            line-height: 1.7; 
        }
        
        .question-detail-box {
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem; 
            padding: 0.875rem 1.25rem; 
            margin-bottom: 1rem; 
            text-align: left;
        }
        .question-detail-box strong { 
            color: #6b7280;  
            font-weight: 400; 
            display: block; 
            margin-bottom: 0.25rem; 
            font-size: 0.875rem; 
        }
        .question-detail-box div { 
            color: #1f2937; 
            font-size: 0.95rem; 
            line-height: 1.65;
        }

        .question-prompt { 
            margin-top: 1.75rem; 
            font-weight: 600;  
            color: #111827;    
        }

        .options {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 1.5rem;
        }
        .option {
            padding: 0.9rem 1.25rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            background-color: #f9fafb; 
            color: #374151; 
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
        }
        .option:hover:not(.disabled):not(.answered) {
            background-color: #f3f4f6; 
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }
        .option.correct {
            background-color: #d1fae5; 
            border-color: #6ee7b7; 
            color: #065f46; 
            font-weight: 600;
        }
        .option.incorrect {
            background-color: #fee2e2; 
            border-color: #fca5a5; 
            color: #991b1b; 
            font-weight: 600;
        }
        /* Styles for typed answer input */
        #typed-answer-container {
            margin-bottom: 1.5rem;
        }
        #typed-answer-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
            color: #374151;
            margin-bottom: 0.75rem;
        }
        #typed-answer-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        #submit-typed-answer-btn {
            background-color: #10b981; /* Tailwind emerald-500 */
        }
        #submit-typed-answer-btn:hover:not(:disabled) {
            background-color: #059669; /* Tailwind emerald-600 */
        }


        .explanation {
            background-color: #e0f2fe; 
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            color: #0c4a6e; 
            text-align: left;
            font-size: 0.95rem;
            border: 1px solid #bae6fd; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            line-height: 1.6;
        }
        .explanation strong {
            color: #075985; 
        }
        .explanation .memo-point { /* Style for memo points */
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px dashed #93c5fd; /* sky-300 */
            font-size: 0.9rem;
            color: #0369a1; /* sky-700 */
        }
        .explanation .memo-point strong {
             color: #0c4a6e; /* sky-800 */
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }
        .quiz-btn {
            padding: 0.75rem 1.5rem; 
            border-radius: 0.375rem; 
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            border: none;
            font-size: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); 
        }
        .quiz-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-1px); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }

        .start-quiz-btn { 
            background-color: #2563eb; 
            font-size: 1.1rem; 
            padding: 0.8rem 2rem;
            margin-top: 1rem; 
        }
        .start-quiz-btn:hover:not(:disabled) {
            background-color: #1d4ed8; 
        }
        .next-btn { 
            background-color: #16a34a; 
        }
        .next-btn:hover:not(:disabled) {
            background-color: #15803d; 
        }
        .prev-btn { 
            background-color: #0ea5e9; 
        }
        .prev-btn:hover:not(:disabled) {
            background-color: #0284c7; 
        }
        .finish-btn { 
            background-color: #dc2626; 
        }
        .finish-btn:hover:not(:disabled) {
            background-color: #b91c1c; 
        }
        .restart-btn { 
            background-color: #4f46e5; 
            font-size: 1.1rem;
            padding: 0.8rem 2rem;
        }
        .restart-btn:hover:not(:disabled) {
            background-color: #4338ca; 
        }
        .review-btn { 
            background-color: #7e22ce; 
        }
        .review-btn:hover:not(:disabled) {
            background-color: #6b21a8; 
        }
        .summary {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }
        .summary h2 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: #1f2937;
            font-weight: 700;
        }
        .summary p {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: #374151;
        }
        #summary-container { 
            display: none;
        }
        .feedback {
            margin-top: 1.5rem;
            padding: 0.75rem;
            border-radius: 0.375rem;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }
        .feedback.correct {
            background-color: #dcfce7; 
            border: 1px solid #86efac; 
            color: #166534; 
        }
        .feedback.incorrect {
            background-color: #fee2e2; 
            border: 1px solid #fca5a5; 
            color: #991b1b; 
        }
        .option.disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .option.answered:not(.correct):not(.incorrect) {
            opacity: 0.6;
        }
        #category-select-container {
            display: block;
            margin-bottom: 2rem;
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
         @media (min-width: 640px) {
            #category-select-container {
                padding: 2rem;
            }
        }
        #category-select, #num-questions-select {
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            color: #374151;
            background-color: #f9fafb;
            transition: border-color 0.2s ease;
            margin-top: 0.5rem;
            width: 100%;
            max-width: 400px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #category-select:focus, #num-questions-select:focus {
            outline: none;
            border-color: #2563eb; 
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .progress-bar-container {
            width: 100%;
            background-color: #e5e7eb; 
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .progress-bar {
            height: 12px;
            width: 0%;
            background-color: #2563eb; 
            border-radius: 0.375rem;
            transition: width 0.3s ease-in-out;
        }
        .question-counter {
            font-size: 0.9rem;
            color: #6b7280; 
        }
        .back-to-menu-link {
            text-decoration: none;
            color: #2563eb; 
            font-weight: 500;
            font-size: 0.9rem;
        }
        .back-to-menu-link:hover {
            color: #1d4ed8; 
            text-decoration: underline;
        }
        #answer-mode-select-container {
            margin-top: 1.5rem; 
            margin-bottom: 1rem; 
        }
        #answer-mode-select-container label {
            margin-right: 0.75rem; 
            font-size: 0.95rem;
            color: #374151; 
        }
        #answer-mode-select-container input[type="radio"] {
            margin-right: 0.25rem; 
            accent-color: #2563eb; 
        }

    </style>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUbKyKLO8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44SU3AYApZ293QOZCmmSWGYeNQ4+AccTVMyr8EPLX" crossorigin="anonymous"></script>
</head>
<body class="bg-gray-100">
    <div class="container">
        <header id="main-header" class="my-6 md:my-8">
             <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">薬理学クイズ</h1>
        </header>

        <div id="category-select-container">
           <label for="category-select" class="block text-slate-700 text-lg font-semibold mb-2">出題カテゴリーを選択してください:</label>
           <select id="category-select" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
               <option value="all">全ての薬物</option>
               <option value="神経系">神経系に作用する薬物</option>
               <option value="循環器系">循環器系に作用する薬物</option>
               <option value="局所麻酔薬">局所麻酔薬</option>
               <option value="末梢性筋弛緩薬">末梢性筋弛緩薬</option>
               <option value="交感神経刺激薬">交感神経刺激薬</option>
               <option value="交感神経遮断薬">交感神経遮断薬</option>
               <option value="その他">その他の薬物</option>
           </select>

           <label for="num-questions-select" class="block text-slate-700 text-lg font-semibold mb-2 mt-6">出題数を選択してください:</label>
           <select id="num-questions-select" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
               <option value="5">5問</option>
               <option value="10" selected>10問</option>
               <option value="15">15問</option>
               <option value="20">20問</option>
               <option value="all">全ての問題</option>
           </select>

           <div id="answer-mode-select-container">
                 <label class="block text-slate-700 text-lg font-semibold mb-2 mt-6">解答形式を選択してください:</label>
                 <div>
                     <input type="radio" id="mode-multiple-choice" name="answer-mode" value="multiple-choice" checked>
                     <label for="mode-multiple-choice">選択式</label>
                     <input type="radio" id="mode-typed-input" name="answer-mode" value="typed-input" class="ml-4">
                     <label for="mode-typed-input">単語入力式</label>
                 </div>
           </div>

           <button id="start-quiz-btn" class="quiz-btn start-quiz-btn">クイズを開始する</button>
        </div>

        <div id="quiz-container"> 
            <div id="quiz-card-element"> 
                <div id="quiz-card-content">
                    <div class="flex justify-between items-center mb-4">
                        <a href="#" id="back-to-menu-btn" class="back-to-menu-link">&larr; メニューに戻る</a>
                        <div class="question-counter" id="question-counter"></div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div id="question" class="question"></div>
                    <div id="options" class="options"></div>
                    <div id="typed-answer-container" style="display: none;">
                        <input type="text" id="typed-answer-input" placeholder="薬物名を入力してください">
                        <button id="submit-typed-answer-btn" class="quiz-btn w-full">解答する</button>
                    </div>
                    <div id="feedback" class="feedback" style="display: none;"></div>
                    <div id="explanation" class="explanation" style="display: none;"></div>
                    <div class="controls">
                        <button id="prev-btn" class="quiz-btn prev-btn">前へ</button>
                        <button id="next-btn" class="quiz-btn next-btn">次へ</button>
                        <button id="finish-btn" class="quiz-btn finish-btn" style="display: none;">終了</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="summary-container" class="summary"> 
            <h2>あなたの成績</h2>
            <p>正解数: <span id="correct-count">0</span> / <span id="total-questions">0</span></p>
            <p>正答率: <span id="accuracy">0</span>%</p>
            <div id="review-incorrect-container" class="mt-4">
            </div>
            <button id="review-incorrect-btn" class="quiz-btn review-btn mt-4" style="display: none;">間違えた問題を復習する</button>
            <button id="restart-btn" class="quiz-btn restart-btn mt-2">もう一度挑戦する</button>
        </div>
    </div>

    <script>
        // KaTeX auto-render configuration
        document.addEventListener("DOMContentLoaded", function() {
            // Options for KaTeX rendering, stored globally for reuse.
            const sharedKatexOptions = {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '$', right: '$', display: false},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false // Prevents rendering errors from stopping script execution
            };

            // Configure the auto-render script.
            // It looks for `window.renderMathInElementOptions`.
            window.renderMathInElementOptions = sharedKatexOptions;

            // Ensure existing manual calls in the codebase that use `window.katexRenderOptions`
            // also use these same options.
            window.katexRenderOptions = sharedKatexOptions;

            // The auto-render.min.js script (loaded with `defer`) will now use `sharedKatexOptions`
            // for its initial scan of the document.
            // Manual calls in `loadQuestion`, `showSummary` etc. will also use `sharedKatexOptions`
            // via `window.katexRenderOptions`.
        });

        // Drug data array with memo points (LaTeX updated)
        const drugData = [
            { name: "アセチルコリン", mechanism: "ムスカリン受容体刺激", characteristics: "神経伝達物質、コリンエステラーゼで分解", applications: "神経伝達、血管拡張", category: "神経系", memo: "" },
            { name: "アトロピン", mechanism: "ムスカリン受容体遮断", characteristics: "抗コリン作用、散瞳、抗痙攣", applications: "散瞳、前投薬、鎮痙、徐脈治療", category: "神経系", memo: "抗コリン薬の代表。副作用: 口渇、便秘、頻脈、排尿困難など。" },
            { name: "パパベリン", mechanism: "ホスホジエステラーゼ阻害", characteristics: "平滑筋弛緩作用、血管拡張作用", applications: "血管拡張、鎮痙", category: "循環器系", memo: "" },
            { name: "アドレナリン", mechanism: "アドレナリン受容体($\\alpha,\\beta$)刺激", characteristics: "心機能亢進、血管収縮($\\alpha$)/拡張($\\beta_2$)、気管支拡張($\\beta_2$)", applications: "アナフィラキシー、心停止、気管支喘息", category: "交感神経刺激薬", memo: "$\\alpha$・$\\beta$両作用。アナフィラキシーの第一選択。" },
            { name: "ノルアドレナリン", mechanism: "アドレナリン受容体(主に$\\alpha$,一部$\\beta_1$)刺激", characteristics: "血管収縮($\\alpha_1$)、血圧上昇、心機能亢進($\\beta_1$)", applications: "ショック時の昇圧", category: "交感神経刺激薬", memo: "主に$\\alpha$刺激で昇圧作用が強い。" },
            { name: "プロプラノロール", mechanism: "非選択的$\\beta$受容体遮断", characteristics: "心拍数減少、血圧低下、気管支収縮、うっ血性心不全患者には禁忌", applications: "高血圧、狭心症、不整脈、片頭痛予防", category: "交感神経遮断薬", memo: "非選択的$\\beta$遮断薬の代表。気管支喘息に禁忌。" },
            { name: "フェントラミン", mechanism: "非選択的$\\alpha$受容体遮断", characteristics: "血管拡張、血圧低下、イミダゾリン誘導体", applications: "褐色細胞腫、末梢血管障害", category: "交感神経遮断薬", memo: "$\\alpha_1$、$\\alpha_2$両方を遮断。" },
            { name: "イソプレナリン", mechanism: "非選択的$\\beta$受容体刺激", characteristics: "心機能亢進($\\beta_1$)、気管支拡張($\\beta_2$)、血管拡張($\\beta_2$)", applications: "気管支喘息、徐脈、房室ブロック", category: "交感神経刺激薬", memo: "$\\beta_1$、$\\beta_2$両方を刺激。" },
            { name: "スキサメトニウム", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体刺激(持続的脱分極)", characteristics: "脱分極性筋弛緩、アセチルコリン2分子結合構造、血漿ChEで分解、作用時間短い(約5分)、悪性高熱症・緑内障に禁忌", applications: "麻酔時の筋弛緩、気管内挿管時の筋弛緩", category: "末梢性筋弛緩薬", memo: "脱分極性筋弛緩薬。サクシニルコリン。作用発現が速く、持続が短い。拮抗薬なし。" },
            { name: "ベクロニウム", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、ステロイド骨格、ヒスタミン遊離作用弱い、作用時間約1時間", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", memo: "非脱分極性筋弛緩薬。スガマデクスで拮抗可能。" },
            { name: "エドロホニウム", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "抗コリンエステラーゼ作用、骨格筋直接刺激作用、作用持続時間非常に短い", applications: "重症筋無力症の診断", category: "その他", memo: "テンシロンテストに使用。" },
            { name: "ジアゼパム", mechanism: "$GABA_A$受容体アロステリック修飾 (ベンゾジアゼピン結合部位)", characteristics: "抗不安、筋弛緩、抗痙攣", applications: "不安障害、てんかん、筋痙攣", category: "神経系", memo: "ベンゾジアゼピン系抗不安薬。" },
            { name: "タムスロシン", mechanism: "選択的$\\alpha_{1A}$受容体遮断", characteristics: "前立腺・尿道平滑筋弛緩、前立腺$\\alpha_{1A}$受容体への選択性が高い", applications: "前立腺肥大症に伴う排尿障害", category: "交感神経遮断薬", memo: "$\\alpha_{1A}$選択性が高く、血管への影響が少ない。" },
            { name: "ニフェジピン", mechanism: "$Ca^{2+}$チャネル遮断 (L型)", characteristics: "血管拡張、血圧低下、ジヒドロピリジン系", applications: "高血圧、狭心症", category: "循環器系", memo: "ジヒドロピリジン系$Ca^{2+}$拮抗薬。" },
            { name: "エフェドリン", mechanism: "混合型アドレナリン作動薬 (直接$\\alpha\\beta$刺激＋NA遊離促進)", characteristics: "MAOやCOMTで分解されない、中枢興奮作用、経口投与可能", applications: "気管支喘息、低血圧、鼻閉", category: "交感神経刺激薬", memo: "麻黄の成分。経口投与可能。" },
            { name: "ピロカルピン", mechanism: "ムスカリン受容体刺激", characteristics: "縮瞳、発汗・唾液分泌促進", applications: "緑内障、口腔乾燥症(シェーグレン症候群)", category: "神経系", memo: "" },
            { name: "ブチルスコポラミン", mechanism: "ムスカリン受容体遮断", characteristics: "抗コリン作用、鎮痙、4級アンモニウム化合物で中枢作用弱い", applications: "消化管痙攣、胆道・尿路痙攣", category: "神経系", memo: "4級アンモニウム構造のため中枢作用は弱い。" },
            { name: "ロピバカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、長時間作用型(3-5時間)、ブピバカインのS体で心毒性低い", applications: "硬膜外麻酔、伝達麻酔、浸潤麻酔", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の仲間。ブピバカインのS体で心毒性が低い。名前に濁音あり。" },
            { name: "リドカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、中時間作用型(1.5-2時間)、抗不整脈作用(Ib群)、安全性高い", applications: "硬膜外麻酔、伝達麻酔、浸潤麻酔、表面麻酔、心室性不整脈", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の「り」。局所麻酔薬の代表。名前に濁音あり。" },
            { name: "プロカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "エステル型、短時間作用型(約1時間)、血中ChEで分解、アレルギー反応注意、組織浸透性低い", applications: "浸潤麻酔、伝達麻酔、硬膜外麻酔、脊椎麻酔", category: "局所麻酔薬", memo: "【エステル型】「プロエステ、手とか安心効果」の「プロ」。名前に濁音なし。血漿ChEで分解、作用短くアレルギー注意。" },
            { name: "テトラカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "エステル型、プロカインより作用時間長い(1.5-2時間)、効力・毒性強い", applications: "脊椎麻酔、硬膜外麻酔、伝達麻酔、浸潤麻酔、表面麻酔", category: "局所麻酔薬", memo: "【エステル型】「プロエステ、手とか安心効果」の「手と」。名前に濁音なし。プロカインより強力・長時間。" },
            { name: "コカイン", mechanism: "電位依存性Naチャネル遮断、NA再取込阻害", characteristics: "エステル型、局所麻酔作用、血管収縮作用、中枢興奮作用、精神依存性(麻薬指定)", applications: "表面麻酔(眼科・耳鼻科)", category: "局所麻酔薬", memo: "【エステル型】「プロエステ、手とか安心効果」の「効果」。名前に濁音なし。麻薬指定。血管収縮作用も併せ持つ。" },
            { name: "カプサイシン", mechanism: "$TRPV_1$受容体作動", characteristics: "知覚神経刺激(灼熱感)、鎮痛作用 (バニロイド受容体作動薬)", applications: "疼痛緩和 (外用剤・軟膏、神経障害性疼痛)", category: "その他", memo: "" },
            { name: "ジブカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、効力最強、毒性も強い、作用時間長い", applications: "脊椎麻酔、伝達・浸潤麻酔(歯科領域)、表面麻酔", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の「し」。効力・毒性ともに最強クラス。名前に濁音あり。" },
            { name: "レボブピバカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、長時間作用型、ブピバカインのS体、心毒性低い", applications: "硬膜外麻酔、神経ブロック", category: "局所麻酔薬", memo: "【アミド型】ブピバカインのS体（左旋性）で心毒性を軽減。ロピバカインと類似。名前に濁音あり。" },
            { name: "メピバカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、中時間作用型(1.5-2時間)、血管収縮作用あり(アドレナリン添加不要な場合も)、アナフィラキシー注意", applications: "硬膜外麻酔、伝達麻酔、浸潤麻酔", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の「バカ～ン」の一員。リドカインと似た作用時間。名前に濁音あり。" },
            { name: "プリロカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、中時間作用型、メトヘモグロビン血症に注意", applications: "浸潤麻酔、伝達麻酔、歯科領域の浸潤麻酔", category: "局所麻酔薬", memo: "【アミド型】だが「濁音なし」の例外。メトヘモグロビン血症の副作用に注意。" },
            { name: "アルチカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型（チオフェン環を持つ）、強酸性条件下でも効果発揮、組織浸透性高い", applications: "歯科麻酔、口腔粘膜局所麻酔", category: "局所麻酔薬", memo: "【アミド型】だが「濁音なし」の例外。チオフェン環構造が特徴で歯科でよく用いられる。" },
            { name: "ボツリヌス毒素A型", mechanism: "アセチルコリン遊離抑制 (神経終末)", characteristics: "ボツリヌス菌産生毒素、効果3-4ヶ月持続", applications: "眼瞼痙攣、片側顔面痙攣、痙性斜頸、表情皺(眉間・目尻)", category: "末梢性筋弛緩薬", memo: "" },
            { name: "ロクロニウム", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、ステロイド骨格、作用発現速い、スガマデクスで拮抗", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", memo: "" },
            { name: "ベシル酸シスアトラクリウム", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、アトラクリウムの異性体、ホフマン分解、副作用少ない", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", memo: "" },
            { name: "ダントロレンナトリウム", mechanism: "筋小胞体リアノジン受容体($Ca^{2+}$遊離チャネル)抑制", characteristics: "骨格筋の興奮収縮連関を抑制、骨格筋直接電気刺激による収縮も抑制", applications: "悪性高熱症、悪性症候群、痙性麻痺", category: "末梢性筋弛緩薬", memo: "" },
            { name: "スガマデクス", mechanism: "ロクロニウム・ベクロニウムを包接化し不活性化", characteristics: "修飾$\\gamma$シクロデキストリン、筋弛緩回復薬", applications: "ロクロニウム・ベクロニウムによる筋弛緩からの回復", category: "その他", memo: "" },
            { name: "テトロドトキシン", mechanism: "電位依存性Naチャネル遮断 (細胞外から蓋をする)", characteristics: "フグ毒、Naチャネル選択性高い、強力な局所麻酔作用だが臨床応用なし", applications: "薬理学的試薬", category: "その他", memo: "" },
            { name: "ヘミコリニウム", mechanism: "コリン作動性神経終末へのコリン取り込み阻害 (ACh合成阻害)", characteristics: "現在使用されていない", applications: "薬理学的試薬", category: "神経系", memo: "" },
            { name: "ツボクラリン", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "d-ツボクラリン、矢毒クラーレ主成分、ヒスタミン遊離作用、自律神経節遮断作用、現在使用されていない", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", memo: "" },
            { name: "ガラミン", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "Daniel Bovet開発、ツボクラリンより弱い、ヒスタミン遊離作用なし、心臓副交感神経遮断で血圧・心拍数上昇、現在使用されていない", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", memo: "" },
            { name: "パンクロニウム", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、ステロイド骨格、ツボクラリンより強力、作用時間長い、ヒスタミン遊離・自律神経節遮断作用弱い、現在使用されていない", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", memo: "" },
            { name: "ジピベフリン", mechanism: "$\\alpha/\\beta$受容体刺激薬", characteristics: "アドレナリンのプロドラッグ、MAO・COMTによる代謝を受けにくい", applications: "低血圧、緑内障", category: "交感神経刺激薬", memo: "" },
            { name: "ナファゾリン", mechanism: "$\\alpha_1$受容体刺激薬", characteristics: "細動脈血管の収縮", applications: "表在性充血(眼)、鼻粘膜充血", category: "交感神経刺激薬", memo: "" },
            { name: "フェニレフリン", mechanism: "$\\alpha_1$受容体刺激薬", characteristics: "血管収縮、瞳孔散大筋の収縮", applications: "低血圧、散瞳薬、局所麻酔薬の配合剤", category: "交感神経刺激薬", memo: "" },
            { name: "メトキサミン", mechanism: "$\\alpha_1$受容体刺激薬", characteristics: "末梢血管の収縮", applications: "低血圧", category: "交感神経刺激薬", memo: "" },
            { name: "クロニジン", mechanism: "中枢性$\\alpha_2$受容体刺激薬 (一部末梢性)", characteristics: "眼房水の産生抑制・排出促進、鎮静、鎮痛", applications: "高血圧、緑内障、片頭痛予防、薬物離脱症状緩和", category: "交感神経遮断薬", memo: "" },
            { name: "メチルドパ", mechanism: "中枢性$\\alpha_2$受容体刺激薬 ($\\alpha$-メチルNAに変換)", characteristics: "ドパ脱炭酸酵素により代謝され作用", applications: "妊娠高血圧", category: "交感神経遮断薬", memo: "" },
            { name: "ドブタミン", mechanism: "$\\beta_1$受容体刺激薬", characteristics: "合成カテコールアミン、心筋収縮力を増強する", applications: "急性循環不全、うっ血性心不全、心原性ショック", category: "交感神経刺激薬", memo: "" },
            { name: "デノパミン", mechanism: "$\\beta_1$受容体刺激薬", characteristics: "非カテコールアミン、経口投与可能、心筋収縮力を増強する", applications: "慢性心不全", category: "交感神経刺激薬", memo: "" },
            { name: "サルブタモール", mechanism: "選択的$\\beta_2$受容体刺激薬", characteristics: "第二世代の$\\beta_2$作用薬、中時間作用型、気管支拡張", applications: "気管支喘息、気管支炎、COPD", category: "交感神経刺激薬", memo: "" },
            { name: "ホルモテロール", mechanism: "選択的$\\beta_2$受容体刺激薬", characteristics: "第三世代の$\\beta_2$作用薬、長時間作用型、気管支拡張", applications: "気管支喘息(発作治療・管理)、COPD", category: "交感神経刺激薬", memo: "" },
            { name: "クレンブテロール", mechanism: "選択的$\\beta_2$受容体刺激薬", characteristics: "気管支平滑筋の弛緩、排尿筋弛緩", applications: "気管支喘息、気管支炎、腹圧性尿失禁", category: "交感神経刺激薬", memo: "" },
            { name: "リトドリン", mechanism: "選択的$\\beta_2$受容体刺激薬", characteristics: "子宮平滑筋$\\beta_2$受容体に選択性が高い、子宮弛緩", applications: "切迫流産・早産", category: "交感神経刺激薬", memo: "" },
            { name: "ミラベグロン", mechanism: "選択的$\\beta_3$受容体刺激薬", characteristics: "膀胱平滑筋弛緩、畜尿機能の亢進", applications: "過活動膀胱の諸症状(尿意切迫感、頻尿、切迫性尿失禁)", category: "交感神経刺激薬", memo: "" },
            { name: "チラミン", mechanism: "間接型アドレナリン作動薬", characteristics: "ノルアドレナリン遊離促進、MAOにより作用消失", applications: "医薬品ではない (チーズ、赤ワイン等に含有)", category: "その他", memo: "" },
            { name: "メタンフェタミン", mechanism: "間接型アドレナリン作動薬", characteristics: "ノルアドレナリン・ドパミン遊離促進、覚せい剤、精神依存・耐性強い", applications: "ナルコレプシー、(注意欠陥・多動性障害)", category: "神経系", memo: "" },
            { name: "ドパミン", mechanism: "ドパミン受容体作動薬、$\\alpha\\beta$受容体作動(高用量)", characteristics: "内因性カテコールアミン、腎血管拡張(低用量)", applications: "急性循環不全、心原性ショック、出血性ショック", category: "交感神経刺激薬", memo: "" },
            { name: "エルゴタミン", mechanism: "$\\alpha$受容体遮断薬、$5-HT_{1B/1D}$受容体作動薬", characteristics: "麦角アルカロイド、脳血管収縮作用", applications: "片頭痛(発作治療)", category: "神経系", memo: "" },
            { name: "エルゴメトリン", mechanism: "$\\alpha$受容体遮断薬、子宮平滑筋収縮", characteristics: "麦角アルカロイド、子宮選択性が高い", applications: "分娩後の弛緩性子宮出血、子宮収縮促進", category: "その他", memo: "" },
            { name: "プラゾシン", mechanism: "選択的$\\alpha_1$受容体遮断薬", characteristics: "血管拡張、血圧低下、初回投与時の起立性低血圧に注意", applications: "高血圧、(前立腺肥大症に伴う排尿障害)", category: "交感神経遮断薬", memo: "" },
            { name: "ウラピジル", mechanism: "選択的$\\alpha_1$受容体遮断薬、$5-HT_{1A}$受容体作動", characteristics: "血管拡張作用", applications: "高血圧、(前立腺肥大症に伴う排尿障害)", category: "交感神経遮断薬", memo: "" },
            { name: "ピンドロール", mechanism: "非選択的$\\beta$受容体遮断薬 (ISA+)", characteristics: "内因性交感神経刺激作用(ISA)有り(約0.6)", applications: "高血圧、狭心症、頻脈性不整脈", category: "交感神経遮断薬", memo: "" },
            { name: "チモロール", mechanism: "非選択的$\\beta$受容体遮断薬 (ISA-)", characteristics: "内因性交感神経刺激作用(ISA)無し、効力が強い、眼房水産生抑制", applications: "緑内障、高眼圧症、(高血圧、狭心症)", category: "交感神経遮断薬", memo: "" },
            { name: "ニプラジロール", mechanism: "非選択的$\\beta$受容体遮断薬 ($\\alpha_1$遮断作用も, ISA-)", characteristics: "NO遊離作用、ニトロ基を持つ", applications: "高血圧、狭心症、緑内障", category: "交感神経遮断薬", memo: "" },
            { name: "ベタキソロール", mechanism: "選択的$\\beta_1$受容体遮断薬 (ISA-)", characteristics: "眼房水の産生抑制", applications: "高血圧、狭心症、緑内障", category: "交感神経遮断薬", memo: "" },
            { name: "エスモロール", mechanism: "選択的$\\beta_1$受容体遮断薬 (ISA-)", characteristics: "超短時間作用型、エステラーゼで分解", applications: "手術時の頻脈性不整脈・高血圧の救急処置", category: "交感神経遮断薬", memo: "" },
            { name: "カルベジロール", mechanism: "非選択的$\\beta$受容体遮断薬 ($\\alpha_1$遮断作用も)", characteristics: "抗酸化作用、血管拡張作用、喘息患者には禁忌", applications: "高血圧、狭心症、慢性心不全", category: "交感神経遮断薬", memo: "" },
            { name: "ラベタロール", mechanism: "非選択的$\\beta$受容体遮断薬 ($\\alpha_1$遮断作用も)", characteristics: "ISAをわずかに有する、血圧降下、心拍出量減少", applications: "高血圧（高血圧救急症も）、狭心症", category: "交感神経遮断薬", memo: "" },
            { name: "アミノ安息香酸エチル", mechanism: "電位依存性Naチャネル遮断", characteristics: "エステル型、水に難溶、外用剤(軟膏)・内服(鎮痛)", applications: "表面麻酔(鎮痒、胃炎鎮痛)", category: "局所麻酔薬", memo: "【エステル型】「プロエステ、手とか安心効果」の「安」。ベンゾカイン。名前に濁音なし。" },
            { name: "オキシブプロカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "エステル型、プロカインより速やかに分解", applications: "表面麻酔(眼科領域)", category: "局所麻酔薬", memo: "【エステル型】だが「濁音あり」の例外。「オキシ」は「Oxy（眼）」に使う。「ブプロカイン」と名前が似ているがエステル型。" },
            { name: "オキセサゼイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、強酸性下でも作用、胃粘膜局所麻酔薬、ガストリン遊離抑制", applications: "食道炎・胃炎・胃潰瘍等の疼痛・嘔吐・げっぷ等", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の「お」。「オキセ」は「胃」に効く。名前に濁音「ゼ」あり。ストロカイン。" },
            { name: "ブピバカイン", mechanism: "電位依存性Naチャネル遮断", characteristics: "アミド型、長時間作用型(3-5時間)、血管収縮薬なしでも作用時間長い、心毒性に注意", applications: "脊椎麻酔、伝達麻酔、硬膜外麻酔", category: "局所麻酔薬", memo: "【アミド型】「網戸におしり、バカ～ン♡」の「バカ～ン」の一員。「ブピ」っと太く長く効くが、心「毒」性「高」。マーカイン。名前に濁音「ブ」「ピ」「バ」あり。" },
            { name: "フィゾスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "カラバル豆アルカロイド、3級アミンで血液脳関門通過、現在使用されていない", applications: "（歴史的）抗コリン薬中毒の解毒", category: "神経系", memo: "" }, 
            { name: "ネオスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成4級アンモニウム、骨格筋直接刺激作用($\\mathrm{N_M}, \\mathrm{N_N}$受容体)", applications: "重症筋無力症、クラーレ剤による呼吸抑制、麻痺性イレウス", category: "神経系", memo: "" }, 
            { name: "ジスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成4級アンモニウム、骨格筋直接刺激作用、作用時間長い", applications: "重症筋無力症、排尿困難(術後・神経因性膀胱)", category: "神経系", memo: "" }, 
            { name: "ピリドスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成4級アンモニウム、骨格筋直接刺激作用", applications: "重症筋無力症", category: "神経系", memo: "" }, 
            { name: "アンベノニウム", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成4級アンモニウム、骨格筋直接刺激作用", applications: "重症筋無力症", category: "神経系", memo: "" }, 
            { name: "$\\alpha$-ブンガロトキシン", mechanism: "ニコチン性アセチルコリン($\\mathrm{N_M}$)受容体非競合的・不可逆的遮断", characteristics: "ヘビ毒の一種", applications: "研究用試薬", category: "その他", memo: "" }
        ];
        
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let selectedCategory = 'all';
        let answerMode = 'multiple-choice'; 
        let isReviewMode = false; 
        let reviewSourceQuestions = []; 

        const questionElement = document.getElementById('question');
        const optionsElement = document.getElementById('options');
        const typedAnswerContainer = document.getElementById('typed-answer-container');
        const typedAnswerInput = document.getElementById('typed-answer-input');
        const submitTypedAnswerBtn = document.getElementById('submit-typed-answer-btn');
        const explanationElement = document.getElementById('explanation');
        const feedbackElement = document.getElementById('feedback');
        const nextButton = document.getElementById('next-btn');
        const prevButton = document.getElementById('prev-btn');
        const finishButton = document.getElementById('finish-btn');
        const quizContainer = document.getElementById('quiz-container');
        const summaryContainer = document.getElementById('summary-container');
        const correctCountElement = document.getElementById('correct-count');
        const totalQuestionsElement = document.getElementById('total-questions');
        const accuracyElement = document.getElementById('accuracy');
        const restartButton = document.getElementById('restart-btn');
        const categorySelectContainer = document.getElementById('category-select-container');
        const categorySelect = document.getElementById('category-select');
        const numQuestionsSelect = document.getElementById('num-questions-select');
        const startQuizButton = document.getElementById('start-quiz-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounterElement = document.getElementById('question-counter');
        const reviewIncorrectContainer = document.getElementById('review-incorrect-container');
        const backToMenuButton = document.getElementById('back-to-menu-btn');
        const reviewIncorrectBtn = document.getElementById('review-incorrect-btn'); 
        const quizCardElement = document.getElementById('quiz-card-element'); 
        const quizCardContent = document.getElementById('quiz-card-content'); 
        const mainHeader = document.getElementById('main-header'); 

        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 50; 
        let isAnimating = false; 

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function initializeQuizData(category, numQuestionsRequestedStr, mode) { 
            isReviewMode = false; 
            selectedCategory = category;
            answerMode = mode; 
            let filteredDrugs = drugData;

            if (category !== 'all') {
                filteredDrugs = drugData.filter(drug => drug.category === category);
            }

            if (filteredDrugs.length === 0) {
                // Using a custom modal or inline message instead of alert
                feedbackElement.textContent = "選択されたカテゴリーに該当する薬物がありません。";
                feedbackElement.className = 'feedback incorrect'; // Style as an error/warning
                feedbackElement.style.display = 'block';
                setTimeout(() => { feedbackElement.style.display = 'none'; }, 3000);


                quizContainer.classList.remove('visible');
                summaryContainer.style.display = 'none';
                categorySelectContainer.style.display = 'block';
                mainHeader.style.display = 'block'; 
                return false;
            }
            
            shuffleArray(filteredDrugs);
            
            let numToDisplay;
            if (numQuestionsRequestedStr === 'all') {
                numToDisplay = filteredDrugs.length;
            } else {
                const requestedNum = parseInt(numQuestionsRequestedStr);
                numToDisplay = Math.min(requestedNum, filteredDrugs.length);
            }
            
            if (numToDisplay === 0 && filteredDrugs.length > 0) {
                numToDisplay = filteredDrugs.length; 
            }

            const selectedQuizDrugs = filteredDrugs.slice(0, numToDisplay);
            generateQuestionsFromSource(selectedQuizDrugs); 
            
            if (quizQuestions.length === 0) {
                 // Using a custom modal or inline message instead of alert
                feedbackElement.textContent = "クイズの問題を生成できませんでした。出題数を調整するか、カテゴリーを変更してください。";
                feedbackElement.className = 'feedback incorrect';
                feedbackElement.style.display = 'block';
                setTimeout(() => { feedbackElement.style.display = 'none'; }, 4000);
                mainHeader.style.display = 'block'; 
                return false;
            }
            return true;
        }

        function generateQuestionsFromSource(sourceDrugArray) {
            quizQuestions = sourceDrugArray.map(correctDrug => {
                const questionText = `
                    <div class="text-left space-y-3 mb-4"> 
                        <div class="question-detail-box bg-sky-50"> 
                            <strong>作用機序:</strong>
                            <div>${correctDrug.mechanism}</div>
                        </div>
                        <div class="question-detail-box bg-emerald-50"> 
                            <strong>薬理学的特徴:</strong>
                            <div>${correctDrug.characteristics}</div>
                        </div>
                        <div class="question-detail-box bg-amber-50"> 
                            <strong>主な適応:</strong>
                            <div>${correctDrug.applications}</div>
                        </div>
                    </div>
                    <p class="question-prompt"><strong>この説明に該当する薬物はどれですか？</strong></p>`;
                
                let optionsArray = [];
                if (answerMode === 'multiple-choice' || isReviewMode) { 
                    let distractors = drugData
                        .filter(d => d.name !== correctDrug.name) 
                        .map(d => d.name);
                    shuffleArray(distractors);
                    
                    let finalDistractors = [];
                    let usedNamesInOptions = new Set([correctDrug.name]);

                    for (const distractorName of distractors) {
                        if (finalDistractors.length < 3 && !usedNamesInOptions.has(distractorName)) {
                            finalDistractors.push(distractorName);
                            usedNamesInOptions.add(distractorName);
                        }
                        if (finalDistractors.length >= 3) break;
                    }
                    
                    while(finalDistractors.length < 3 && drugData.length > finalDistractors.length + 1) { 
                        const randomDrugIndex = Math.floor(Math.random() * drugData.length);
                        const randomDrugName = drugData[randomDrugIndex].name;
                        if (!usedNamesInOptions.has(randomDrugName)) { 
                            finalDistractors.push(randomDrugName);
                            usedNamesInOptions.add(randomDrugName);
                        }
                        if (finalDistractors.length >=3) break;
                    }
                    finalDistractors = finalDistractors.slice(0,3);
                    optionsArray = [correctDrug.name, ...finalDistractors];
                    shuffleArray(optionsArray);
                }
                
                let explanationContent = `<strong>${correctDrug.name}</strong><br>作用機序: ${correctDrug.mechanism}<br>薬理学的特徴: ${correctDrug.characteristics}<br>主な適応: ${correctDrug.applications}`;
                if (correctDrug.memo) {
                    explanationContent += `<div class="memo-point"><strong>暗記ポイント・比較:</strong><br>${correctDrug.memo}</div>`;
                }


                return {
                    questionText: questionText,
                    options: optionsArray, 
                    correctAnswer: correctDrug.name,
                    explanationText: explanationContent, 
                    drugDetails: correctDrug 
                };
            });
        }
        
        function animateAndLoadQuestion(newIndex, direction) {
            if (isAnimating) return; 
            isAnimating = true;

            quizCardContent.style.opacity = '0';
            if (direction === 'next') {
                quizCardContent.style.transform = 'translateX(-100%)'; 
            } else { 
                quizCardContent.style.transform = 'translateX(100%)'; 
            }

            setTimeout(() => {
                loadQuestion(newIndex); 
                
                quizCardContent.style.transition = 'none'; 
                if (direction === 'next') {
                    quizCardContent.style.transform = 'translateX(100%)';
                } else { 
                    quizCardContent.style.transform = 'translateX(-100%)';
                }
                
                quizCardContent.offsetHeight; 

                quizCardContent.style.transition = 'transform 0.35s ease-in-out, opacity 0.35s ease-in-out';
                quizCardContent.style.opacity = '1';
                quizCardContent.style.transform = 'translateX(0)';

                setTimeout(() => {
                    isAnimating = false;
                }, 350); 

            }, 350); 
        }


        function loadQuestion(index) {
            if (index < 0 || index >= quizQuestions.length) return;

            currentQuestionIndex = index;
            const questionData = quizQuestions[index];

            questionElement.innerHTML = questionData.questionText;
            // Use `window.renderMathInElementOptions` which is configured for auto-render and manual calls.
            if (typeof renderMathInElement === 'function' && window.renderMathInElementOptions) {
                renderMathInElement(questionElement, window.renderMathInElementOptions);
            }
            optionsElement.innerHTML = ''; 
            typedAnswerInput.value = ''; 
            typedAnswerInput.classList.remove('border-green-500', 'ring-2', 'ring-green-200', 'border-red-500', 'ring-2', 'ring-red-200');


            if (answerMode === 'multiple-choice' || isReviewMode) { 
                optionsElement.style.display = 'flex';
                typedAnswerContainer.style.display = 'none';
                questionData.options.forEach((optionName) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('option');
                    optionDiv.textContent = optionName;
                    optionDiv.dataset.optionName = optionName; 
                    optionDiv.addEventListener('click', () => selectOption(optionDiv, questionData));
                    optionsElement.appendChild(optionDiv);
                });
            } else { 
                optionsElement.style.display = 'none';
                typedAnswerContainer.style.display = 'block';
                typedAnswerInput.disabled = false;
                submitTypedAnswerBtn.disabled = false;
                typedAnswerInput.focus();
            }


            explanationElement.style.display = 'none';
            feedbackElement.style.display = 'none';
            feedbackElement.textContent = '';
            feedbackElement.className = 'feedback';

            const answered = userAnswers[index];
            if (answered) {
                if (answerMode === 'multiple-choice' || isReviewMode) {
                    optionsElement.childNodes.forEach(optDiv => {
                        optDiv.classList.add('answered');
                        optDiv.classList.add('disabled');
                        if (optDiv.dataset.optionName === questionData.correctAnswer) {
                            optDiv.classList.add('correct');
                        } else if (optDiv.dataset.optionName === answered.selectedDrugName) {
                            optDiv.classList.add('incorrect');
                        }
                    });
                } else { 
                    typedAnswerInput.value = answered.typedAnswer || ''; 
                    typedAnswerInput.disabled = true;
                    submitTypedAnswerBtn.disabled = true;
                    if(answered.isCorrect) {
                        typedAnswerInput.classList.add('border-green-500', 'ring-2', 'ring-green-200');
                    } else {
                        typedAnswerInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    }
                }
                feedbackElement.textContent = answered.isCorrect ? '正解です！' : `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add(answered.isCorrect ? 'correct' : 'incorrect');
                feedbackElement.style.display = 'block';
                explanationElement.innerHTML = questionData.explanationText;
                 // Use `window.renderMathInElementOptions`
                if (typeof renderMathInElement === 'function' && window.renderMathInElementOptions) {
                    renderMathInElement(explanationElement, window.renderMathInElementOptions);
                }
                explanationElement.style.display = 'block';
                nextButton.disabled = false;
            } else {
                nextButton.disabled = true;
            }

            const progressPercentage = quizQuestions.length > 0 ? ((index + 1) / quizQuestions.length) * 100 : 0;
            progressBar.style.width = `${progressPercentage}%`;
            if (isReviewMode) {
                questionCounterElement.textContent = quizQuestions.length > 0 ? `復習問題 ${index + 1} / ${quizQuestions.length}` : '復習問題 0 / 0';
            } else {
                questionCounterElement.textContent = quizQuestions.length > 0 ? `問題 ${index + 1} / ${quizQuestions.length}` : '問題 0 / 0';
            }

            prevButton.disabled = index === 0;
            if (index === quizQuestions.length - 1) {
                nextButton.style.display = 'none';
                finishButton.style.display = 'inline-block';
                finishButton.disabled = !answered; 
            } else {
                nextButton.style.display = 'inline-block';
                finishButton.style.display = 'none';
            }
            if (quizQuestions.length === 0) {
                nextButton.style.display = 'none';
                finishButton.style.display = 'none';
                prevButton.disabled = true;
            }
        }

        function selectOption(selectedOptionDiv, questionData) {
            if (userAnswers[currentQuestionIndex]) return; 

            const selectedDrugName = selectedOptionDiv.dataset.optionName;
            const isCorrect = selectedDrugName === questionData.correctAnswer;

            userAnswers[currentQuestionIndex] = {
                questionIndex: currentQuestionIndex,
                selectedDrugName: selectedDrugName, 
                typedAnswer: null, 
                correctAnswerName: questionData.correctAnswer,
                isCorrect: isCorrect,
                questionText: questionData.questionText,
                drugDetails: questionData.drugDetails 
            };

            if (isCorrect) {
                score++;
                selectedOptionDiv.classList.add('correct');
                feedbackElement.textContent = '正解です！';
                feedbackElement.classList.add('correct');
            } else {
                selectedOptionDiv.classList.add('incorrect');
                feedbackElement.textContent = `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add('incorrect');
                optionsElement.childNodes.forEach(optDiv => {
                    if (optDiv.dataset.optionName === questionData.correctAnswer) {
                        optDiv.classList.add('correct');
                    }
                });
            }

            feedbackElement.style.display = 'block';
            explanationElement.innerHTML = questionData.explanationText;
            // Use `window.renderMathInElementOptions`
            if (typeof renderMathInElement === 'function' && window.renderMathInElementOptions) {
                renderMathInElement(explanationElement, window.renderMathInElementOptions);
            }
            explanationElement.style.display = 'block';

            optionsElement.childNodes.forEach(optDiv => {
                optDiv.classList.add('disabled');
                optDiv.classList.add('answered');
            });

            nextButton.disabled = false;
            if (currentQuestionIndex === quizQuestions.length - 1) {
                finishButton.disabled = false;
            }
        }

        function submitTypedAnswer() {
            if (userAnswers[currentQuestionIndex]) return; 

            const questionData = quizQuestions[currentQuestionIndex];
            const userAnswerText = typedAnswerInput.value.trim();
            
            const normalizedUserAnswer = userAnswerText.toLowerCase().replace(/\s+/g, '');
            const normalizedCorrectAnswer = questionData.correctAnswer.toLowerCase().replace(/\s+/g, '');

            const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

            userAnswers[currentQuestionIndex] = {
                questionIndex: currentQuestionIndex,
                selectedDrugName: null, 
                typedAnswer: userAnswerText, 
                correctAnswerName: questionData.correctAnswer,
                isCorrect: isCorrect,
                questionText: questionData.questionText,
                drugDetails: questionData.drugDetails
            };

            if (isCorrect) {
                score++;
                feedbackElement.textContent = '正解です！';
                feedbackElement.classList.add('correct');
                typedAnswerInput.classList.add('border-green-500', 'ring-2', 'ring-green-200'); 
            } else {
                feedbackElement.textContent = `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add('incorrect');
                typedAnswerInput.classList.add('border-red-500', 'ring-2', 'ring-red-200'); 
            }

            feedbackElement.style.display = 'block';
            explanationElement.innerHTML = questionData.explanationText;
            // Use `window.renderMathInElementOptions`
            if (typeof renderMathInElement === 'function' && window.renderMathInElementOptions) {
                renderMathInElement(explanationElement, window.renderMathInElementOptions);
            }
            explanationElement.style.display = 'block';

            typedAnswerInput.disabled = true;
            submitTypedAnswerBtn.disabled = true;

            nextButton.disabled = false;
            if (currentQuestionIndex === quizQuestions.length - 1) {
                finishButton.disabled = false;
            }
        }
        submitTypedAnswerBtn.addEventListener('click', submitTypedAnswer);
        typedAnswerInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !submitTypedAnswerBtn.disabled) {
                submitTypedAnswer();
            }
        });


        function showSummary() {
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                 quizContainer.style.display = 'none';
            }, 500); 

            summaryContainer.style.display = 'block'; 
            categorySelectContainer.style.display = 'none';
            mainHeader.style.display = 'none'; 

            correctCountElement.textContent = score;
            totalQuestionsElement.textContent = quizQuestions.length;
            const accuracy = quizQuestions.length > 0 ? Math.round((score / quizQuestions.length) * 100) : 0;
            accuracyElement.textContent = accuracy;

            reviewIncorrectContainer.innerHTML = '';
            reviewSourceQuestions = []; 
            const incorrectAnswersForDisplay = userAnswers.filter(ans => ans && !ans.isCorrect);
            
            if (incorrectAnswersForDisplay.length > 0) {
                const reviewTitle = document.createElement('h3');
                reviewTitle.textContent = '間違えた問題の復習:';
                reviewTitle.className = 'text-lg font-semibold mt-6 mb-3 text-left text-gray-700';
                reviewIncorrectContainer.appendChild(reviewTitle);

                const reviewList = document.createElement('ul');
                reviewList.className = 'list-disc pl-5 text-left space-y-3';
                incorrectAnswersForDisplay.forEach(ans => {
                    const listItem = document.createElement('li');
                    listItem.className = 'text-sm text-gray-700 leading-relaxed';
                    const userAnswerDisplay = ans.typedAnswer !== null ? ans.typedAnswer : ans.selectedDrugName;
                    listItem.innerHTML = `<strong class="text-base text-slate-800">問題 ${ans.questionIndex + 1}: ${ans.drugDetails.name}</strong> (あなたの回答: ${userAnswerDisplay})<br>
                                        <div class="pl-2 mt-1 text-xs space-y-0.5">
                                            <p><strong>作用機序:</strong> ${ans.drugDetails.mechanism}</p>
                                            <p><strong>薬理学的特徴:</strong> ${ans.drugDetails.characteristics}</p>
                                            <p><strong>主な適応:</strong> ${ans.drugDetails.applications}</p>
                                        </div>`;
                    reviewList.appendChild(listItem);
                    if (!reviewSourceQuestions.some(rq => rq.name === ans.drugDetails.name)) {
                        reviewSourceQuestions.push(ans.drugDetails);
                    }
                });
                reviewIncorrectContainer.appendChild(reviewList);
                // Use `window.renderMathInElementOptions`
                if (typeof renderMathInElement === 'function' && window.renderMathInElementOptions) {
                    renderMathInElement(reviewList, window.renderMathInElementOptions);
                }
                reviewIncorrectBtn.style.display = 'inline-block'; 
                reviewIncorrectBtn.disabled = false;
            } else if (quizQuestions.length > 0 && score === quizQuestions.length) {
                 const perfectMessage = document.createElement('p');
                 perfectMessage.textContent = '全問正解です！素晴らしい！';
                 perfectMessage.className = 'text-green-600 font-semibold mt-4 text-lg';
                 reviewIncorrectContainer.appendChild(perfectMessage);
                 reviewIncorrectBtn.style.display = 'none'; 
            } else if (quizQuestions.length === 0) {
                const noQuizMessage = document.createElement('p');
                noQuizMessage.textContent = 'クイズは実行されませんでした。';
                noQuizMessage.className = 'text-gray-600 font-semibold mt-4';
                reviewIncorrectContainer.appendChild(noQuizMessage);
                reviewIncorrectBtn.style.display = 'none';
            } else { 
                 reviewIncorrectBtn.style.display = 'none';
            }
        }
        
        function resetQuizState() {
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            quizQuestions = []; 
            progressBar.style.width = '0%';
            questionCounterElement.textContent = '';
            nextButton.style.display = 'inline-block';
            finishButton.style.display = 'none';
            nextButton.disabled = true;
            prevButton.disabled = true;
            isReviewMode = false; 
            typedAnswerInput.classList.remove('border-green-500', 'ring-2', 'ring-green-200', 'border-red-500', 'ring-2', 'ring-red-200');
        }

        function startReviewQuiz() {
            if (reviewSourceQuestions.length === 0) {
                // Using a custom modal or inline message instead of alert
                feedbackElement.textContent = "復習する問題がありません。"; // This feedback might be better placed on the summary screen
                feedbackElement.className = 'feedback incorrect';
                feedbackElement.style.display = 'block';
                setTimeout(() => { feedbackElement.style.display = 'none'; }, 3000);
                return;
            }
            isReviewMode = true;
            answerMode = 'multiple-choice'; 
            
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = []; 
            quizQuestions = []; 
            progressBar.style.width = '0%';
            
            let reviewDrugsToQuiz = [...reviewSourceQuestions]; 
            shuffleArray(reviewDrugsToQuiz); 
            generateQuestionsFromSource(reviewDrugsToQuiz); 

            if (quizQuestions.length > 0) {
                categorySelectContainer.style.display = 'none';
                summaryContainer.style.display = 'none';
                
                quizContainer.style.display = 'block'; 
                setTimeout(() => { 
                    quizContainer.classList.add('visible');
                }, 10);

                mainHeader.style.display = 'none'; 
                
                quizCardContent.style.transition = 'none';
                quizCardContent.style.transform = 'translateX(0)'; 
                quizCardContent.style.opacity = '0'; 
                loadQuestion(0);
                setTimeout(() => { 
                    quizCardContent.style.transition = 'transform 0.35s ease-in-out, opacity 0.35s ease-in-out';
                    quizCardContent.style.opacity = '1';
                }, 20);
            } else {
                // Using a custom modal or inline message instead of alert
                feedbackElement.textContent = "復習問題の生成に失敗しました。";
                feedbackElement.className = 'feedback incorrect';
                feedbackElement.style.display = 'block';
                setTimeout(() => { feedbackElement.style.display = 'none'; }, 3000);

                isReviewMode = false; 
                mainHeader.style.display = 'block'; 
            }
        }

        quizCardElement.addEventListener('touchstart', function(event) {
            if (isAnimating) return;
            touchstartX = event.changedTouches[0].screenX;
        }, {passive: true}); 

        quizCardElement.addEventListener('touchend', function(event) {
            if (isAnimating) return;
            touchendX = event.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            if (touchendX < touchstartX - swipeThreshold) { // Swiped left
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    if (!nextButton.disabled) { 
                        animateAndLoadQuestion(currentQuestionIndex + 1, 'next');
                    }
                } else if (!finishButton.disabled && finishButton.style.display !== 'none') { 
                    finishButton.click(); 
                }
            }
            if (touchendX > touchstartX + swipeThreshold) { // Swiped right
                if (currentQuestionIndex > 0) {
                    animateAndLoadQuestion(currentQuestionIndex - 1, 'prev');
                }
            }
        }


        startQuizButton.addEventListener('click', () => {
            const category = categorySelect.value;
            const numQuestions = numQuestionsSelect.value; 
            const selectedMode = document.querySelector('input[name="answer-mode"]:checked').value;
            
            resetQuizState(); 
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'none'; 
            if (initializeQuizData(category, numQuestions, selectedMode)) { 
                categorySelectContainer.style.display = 'none';
                
                quizContainer.style.display = 'block'; 
                setTimeout(() => { 
                    quizContainer.classList.add('visible');
                }, 10); 

                summaryContainer.style.display = 'none';
                quizCardContent.style.transition = 'none';
                quizCardContent.style.transform = 'translateX(0)';
                quizCardContent.style.opacity = '0';
                loadQuestion(0);
                setTimeout(() => {
                    quizCardContent.style.transition = 'opacity 0.35s ease-in-out'; 
                    quizCardContent.style.opacity = '1';
                }, 50); 
            } else {
                mainHeader.style.display = 'block'; 
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentQuestionIndex < quizQuestions.length - 1 && !nextButton.disabled) {
                animateAndLoadQuestion(currentQuestionIndex + 1, 'next');
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0 && !prevButton.disabled) {
                animateAndLoadQuestion(currentQuestionIndex - 1, 'prev');
            }
        });

        finishButton.addEventListener('click', () => {
            showSummary(); 
            if (isReviewMode) { 
                 mainHeader.style.display = 'block'; 
            }
        });

        restartButton.addEventListener('click', () => {
            resetQuizState();
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'block'; 
            summaryContainer.style.display = 'none';
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                quizContainer.style.display = 'none';
            }, 500);
            categorySelectContainer.style.display = 'block';
        });

        backToMenuButton.addEventListener('click', (e) => {
            e.preventDefault(); 
            resetQuizState();
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'block'; 
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                quizContainer.style.display = 'none';
            }, 500);
            summaryContainer.style.display = 'none';
            categorySelectContainer.style.display = 'block';
        });

        reviewIncorrectBtn.addEventListener('click', () => {
            startReviewQuiz();
        });

        // Initial setup
        categorySelectContainer.style.display = 'block'; 
        quizContainer.style.display = 'none'; 
        quizContainer.classList.remove('visible');
        summaryContainer.style.display = 'none'; 
        mainHeader.style.display = 'block'; 

    </script>
</body>
</html>
