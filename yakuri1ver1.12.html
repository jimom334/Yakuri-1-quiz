<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>薬理学クイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
            text-align: center;
        }
        @media (min-width: 640px) {
            .container {
                padding: 2rem;
            }
        }
        #quiz-card-element {
            background-color: white;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
            padding: 1.5rem;
            margin-bottom: 2rem;
            overflow: hidden; 
            position: relative; 
        }
         @media (min-width: 640px) {
            #quiz-card-element {
                padding: 2rem;
            }
        }
        #quiz-card-content {
            width: 100%;
            transition: transform 0.35s ease-in-out, opacity 0.35s ease-in-out;
            will-change: transform, opacity; 
        }
        #quiz-container {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; 
        }
        #quiz-container.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s; 
        }
        .question {
            font-size: 1.05rem; 
            margin-bottom: 1.5rem;
            color: #1f2937; 
            font-weight: 500; 
            text-align: left;
            line-height: 1.7; 
        }
        .question-detail-box {
            border: 1px solid #e5e7eb; 
            border-radius: 0.5rem; 
            padding: 0.875rem 1.25rem; 
            margin-bottom: 1rem; 
            text-align: left;
        }
        .question-detail-box strong { 
            color: #6b7280;  
            font-weight: 400; 
            display: block; 
            margin-bottom: 0.25rem; 
            font-size: 0.875rem; 
        }
        .question-detail-box div { 
            color: #1f2937; 
            font-size: 0.95rem; 
            line-height: 1.65;
        }
        .question-prompt { 
            margin-top: 1.75rem; 
            font-weight: 600;  
            color: #111827;   
        }
        .options {
            display: flex;
            flex-direction: column;
            align-items: stretch;
            margin-bottom: 1.5rem;
        }
        .option {
            padding: 0.9rem 1.25rem;
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            background-color: #f9fafb; 
            color: #374151; 
            text-align: left;
            font-size: 1rem;
            font-weight: 500;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); 
        }
        .option:hover:not(.disabled):not(.answered) {
            background-color: #f3f4f6; 
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }
        .option.correct { background-color: #d1fae5; border-color: #6ee7b7; color: #065f46; font-weight: 600; }
        .option.incorrect { background-color: #fee2e2; border-color: #fca5a5; color: #991b1b; font-weight: 600; }
        #typed-answer-container { margin-bottom: 1.5rem; }
        #typed-answer-input {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db;
            border-radius: 0.375rem; font-size: 1rem; color: #374151; margin-bottom: 0.75rem;
        }
        #typed-answer-input:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        #submit-typed-answer-btn { background-color: #10b981; }
        #submit-typed-answer-btn:hover:not(:disabled) { background-color: #059669; }
        .explanation {
            background-color: #e0f2fe; border-radius: 0.5rem; padding: 1.25rem;
            margin-top: 1.5rem; margin-bottom: 1.5rem; color: #0c4a6e; 
            text-align: left; font-size: 0.95rem; border: 1px solid #bae6fd; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); line-height: 1.6;
        }
        .explanation strong { color: #075985; }
        .explanation .memo-point {
            margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px dashed #93c5fd; 
            font-size: 0.9rem; color: #0369a1; 
        }
        .explanation .memo-point strong { color: #0c4a6e; }
        .controls {
            display: flex; justify-content: space-between; align-items: center;
            gap: 1rem; margin-top: 2rem;
        }
        .quiz-btn {
            padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600;
            color: white; cursor: pointer;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.15s ease;
            border: none; font-size: 1rem;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06); 
            text-decoration: none;
            display: inline-block;
        }
        .quiz-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .quiz-btn:hover:not(:disabled) {
            transform: translateY(-1px); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }
        .start-quiz-btn { background-color: #2563eb; font-size: 1.1rem; padding: 0.8rem 2rem; margin-top: 1rem; }
        .start-quiz-btn:hover:not(:disabled) { background-color: #1d4ed8; }
        .next-btn { background-color: #16a34a; }
        .next-btn:hover:not(:disabled) { background-color: #15803d; }
        .prev-btn { background-color: #0ea5e9; }
        .prev-btn:hover:not(:disabled) { background-color: #0284c7; }
        .finish-btn { background-color: #dc2626; }
        .finish-btn:hover:not(:disabled) { background-color: #b91c1c; }
        .restart-btn { background-color: #4f46e5; font-size: 1.1rem; padding: 0.8rem 2rem; }
        .restart-btn:hover:not(:disabled) { background-color: #4338ca; }
        .review-btn { background-color: #7e22ce; }
        .review-btn:hover:not(:disabled) { background-color: #6b21a8; }
        .back-to-menu-btn {
            background-color: #64748b; /* slate-500 */
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
            flex-shrink: 0;
        }
        .back-to-menu-btn:hover:not(:disabled) {
            background-color: #475569; /* slate-600 */
        }
        .summary {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem; text-align: center; margin-bottom: 2rem;
        }
        .summary h2 { font-size: 1.8rem; margin-bottom: 1.5rem; color: #1f2937; font-weight: 700; }
        .summary p { font-size: 1.1rem; margin-bottom: 1rem; color: #374151; }
        #summary-container { display: none; }
        .feedback {
            margin-top: 1.5rem; padding: 0.75rem; border-radius: 0.375rem;
            text-align: center; font-weight: 600; font-size: 1rem;
        }
        .feedback.correct { background-color: #dcfce7; border: 1px solid #86efac; color: #166534; }
        .feedback.incorrect { background-color: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; }
        .option.disabled { opacity: 0.7; cursor: not-allowed; }
        .option.answered:not(.correct):not(.incorrect) { opacity: 0.6; }
        #category-select-container {
            display: block; margin-bottom: 2rem; background-color: white;
            padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
         @media (min-width: 640px) { #category-select-container { padding: 2rem; } }
        #num-questions-select {
            padding: 0.75rem 1rem; border-radius: 0.375rem; border: 1px solid #d1d5db;
            font-size: 1rem; color: #374151; background-color: #f9fafb;
            transition: border-color 0.2s ease; margin-top: 0.5rem;
            width: 100%; max-width: 400px; display: block; margin-left: auto; margin-right: auto;
        }
        #num-questions-select:focus {
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .progress-bar-container {
            width: 100%; background-color: #e5e7eb; border-radius: 0.375rem;
            margin-bottom: 1rem; overflow: hidden;
        }
        .progress-bar {
            height: 12px; width: 0%; background-color: #2563eb; 
            border-radius: 0.375rem; transition: width 0.3s ease-in-out;
        }
        .question-counter { font-size: 0.9rem; color: #6b7280; }
        .sub-category-display {
            background-color: #f0f9ff;
            color: #0369a1; 
            border: 1px solid #e0f2fe;
            font-size: 0.9rem; 
            font-weight: 500; 
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            margin-bottom: 1.25rem;
            display: inline-block;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        #answer-mode-select-container {
            margin-top: 1.5rem; margin-bottom: 1rem; 
        }
        #answer-mode-select-container label {
            font-size: 0.95rem; color: #374151; 
        }
        #category-checkboxes-container .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
            max-width: 600px;
            margin: 0.5rem auto 0;
            padding: 0.5rem;
        }
        #category-checkboxes-container .checkbox-item {
            display: block;
        }
        #category-checkboxes-container input[type="checkbox"] {
            display: none;
        }
        #category-checkboxes-container .checkbox-item label {
            display: block;
            padding: 0.6rem 1.2rem;
            border: 1px solid #d1d5db;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.95rem;
            background-color: #f9fafb;
            color: #374151;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        #category-checkboxes-container .checkbox-item label:hover {
            border-color: #a5b4fc;
            background-color: #f3f4f6;
            transform: translateY(-1px);
        }
        #category-checkboxes-container input[type="checkbox"]:checked + label {
            background-color: #e0e7ff;
            border-color: #818cf8;
            color: #3730a3;
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #answer-mode-select-container input[type="radio"],
        #review-options-container input[type="radio"] {
            margin-right: 0.375rem; 
            accent-color: #2563eb; 
            width: 1rem; height: 1rem;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container">
        <header id="main-header" class="my-6 md:my-8">
             <h1 class="text-3xl sm:text-4xl font-bold text-slate-800">薬理学クイズ</h1>
        </header>

        <div id="category-select-container">
           <label class="block text-slate-700 text-lg font-semibold mb-2">出題カテゴリーを選択してください:</label>
           <div id="category-checkboxes-container"></div>
           
           <label for="num-questions-select" class="block text-slate-700 text-lg font-semibold mb-2 mt-6">出題数を選択してください:</label>
           <select id="num-questions-select" class="shadow-sm"></select>

           <div id="answer-mode-select-container">
                <label class="block text-slate-700 text-lg font-semibold mb-2 mt-6">解答形式を選択してください:</label>
                <div>
                    <input type="radio" id="mode-multiple-choice" name="answer-mode" value="multiple-choice" checked>
                    <label for="mode-multiple-choice">選択式</label>
                    <input type="radio" id="mode-typed-input" name="answer-mode" value="typed-input" class="ml-4">
                    <label for="mode-typed-input">単語入力式</label>
                </div>
           </div>

           <button id="start-quiz-btn" class="quiz-btn start-quiz-btn">クイズを開始する</button>
           <p class="text-xs text-gray-400 mt-6">ver1.12</p>
        </div>

        <div id="quiz-container"> 
            <div id="quiz-card-element"> 
                <div id="quiz-card-content">
                    <div class="flex justify-between items-center mb-4">
                        <a href="#" id="back-to-menu-btn" class="quiz-btn back-to-menu-btn">&larr; メニューに戻る</a>
                        <div class="question-counter" id="question-counter"></div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div id="sub-category-display" class="sub-category-display" style="display: none;"></div>
                    <div id="question" class="question"></div>
                    <div id="options" class="options"></div>
                    <div id="typed-answer-container" style="display: none;">
                        <input type="text" id="typed-answer-input" placeholder="薬物名を入力してください">
                        <button id="submit-typed-answer-btn" class="quiz-btn w-full">解答する</button>
                    </div>
                    <div id="feedback" class="feedback" style="display: none;"></div>
                    <div id="explanation" class="explanation" style="display: none;"></div>
                    <div class="controls">
                        <button id="prev-btn" class="quiz-btn prev-btn">前へ</button>
                        <button id="next-btn" class="quiz-btn next-btn">次へ</button>
                        <button id="finish-btn" class="quiz-btn finish-btn" style="display: none;">終了</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="summary-container" class="summary"> 
            <h2>あなたの成績</h2>
            <p>正解数: <span id="correct-count">0</span> / <span id="total-questions">0</span></p>
            <p>正答率: <span id="accuracy">0</span>%</p>
            <div id="review-incorrect-container" class="mt-4">
            </div>
            <div id="review-options-container" class="mt-4" style="display: none;">
                <label class="block text-slate-700 text-md font-semibold mb-2 mt-4">復習時の解答形式:</label>
                <div>
                    <input type="radio" id="review-mode-multiple-choice" name="review-answer-mode" value="multiple-choice" checked>
                    <label for="review-mode-multiple-choice">選択式</label>
                    <input type="radio" id="review-mode-typed-input" name="review-answer-mode" value="typed-input" class="ml-4">
                    <label for="review-mode-typed-input">単語入力式</label>
                </div>
            </div>
            <button id="review-incorrect-btn" class="quiz-btn review-btn mt-4" style="display: none;">間違えた問題を復習する</button>
            <button id="restart-btn" class="quiz-btn restart-btn mt-2">もう一度挑戦する</button>
        </div>
    </div>

    <script>
        const drugData = [
            // 局所麻酔薬
            { name: "プロカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "エステル型、短時間作用型(約1時間)、血中ChEで分解、アレルギー反応注意、組織浸透性低い", applications: "浸潤麻酔、伝達麻酔、硬膜外麻酔、脊椎麻酔", category: "局所麻酔薬", subCategory: "エステル型局所麻酔薬", memo: "エステル型→ラ行がつく。プロカイン、オキシブプロカイン、テトラカイン、アミノ安息香酸エチル。血漿ChEで分解、作用短くアレルギー注意。" },
            { name: "テトラカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "エステル型、プロカインより作用時間長い(1.5-2時間)、効力・毒性強い", applications: "脊椎麻酔、硬膜外麻酔、伝達麻酔、浸潤麻酔、表面麻酔", category: "局所麻酔薬", subCategory: "エステル型局所麻酔薬", memo: "エステル型→ラ行がつく。プロカイン、オキシブプロカイン、テトラカイン、アミノ安息香酸エチル 。プロカインより強力・長時間。" },
            { name: "コカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断、NA再取込阻害", characteristics: "エステル型。局所麻酔作用。血管収縮作用。中枢興奮作用。精神依存性(麻薬指定)。", applications: "表面麻酔(眼科・耳鼻科)", category: "局所麻酔薬", subCategory: "エステル型局所麻酔薬", memo: "エステル型だが、ラ行がつかない例外。名前に濁音なし。麻薬指定。血管収縮作用も併せ持つ。" },
            { name: "アミノ安息香酸エチル", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "エステル型、水に難溶、外用剤(軟膏)・内服(鎮痛)", applications: "表面麻酔(鎮痒、胃炎鎮痛)", category: "局所麻酔薬", subCategory: "エステル型局所麻酔薬", memo: "エステル型→ラ行がつく。プロカイン、オキシブプロカイン、テトラカイン、アミノ安息香酸エチル 。ベンゾカイン。名前に濁音なし。" },
            { name: "オキシブプロカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "エステル型、プロカインより速やかに分解", applications: "表面麻酔(眼科領域)", category: "局所麻酔薬", subCategory: "エステル型局所麻酔薬", memo: "【エステル型】だが「濁音あり」の例外。" },
            { name: "リドカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、中時間作用型(1.5-2時間)、抗不整脈作用(I-b群)、安全性高い", applications: "硬膜外麻酔、伝達麻酔、浸潤麻酔、表面麻酔、心室性不整脈", category: "局所麻酔薬", subCategory: "アミド型局所麻酔薬", memo: "アミド型→濁点「゛」がつく。リドカイン、ジブカイン、メピバカイン、ブピバカイン、オキセザゼイン。局所麻酔薬の代表。名前に濁音あり。" },
            { name: "ジブカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、効力最強、毒性も強い、作用時間長い", applications: "脊椎麻酔、伝達・浸潤麻酔(歯科領域)、表面麻酔", category: "局所麻酔薬", subCategory: "アミド型局所麻酔薬", memo: "アミド型→濁点「゛」がつく。リドカイン、ジブカイン、メピバカイン、ブピバカイン、オキセザゼイン。効力・毒性ともに最強クラス。名前に濁音あり。" },
            { name: "メピバカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、中時間作用型(1.5-2時間)、血管収縮作用あり(アドレナリン添加不要な場合も)、アナフィラキシー注意", applications: "硬膜外麻酔、伝達麻酔、浸潤麻酔", category: "局所麻酔薬", subCategory: "アミド型局所麻酔薬", memo: "アミド型→濁点「゛」がつく。リドカイン、ジブカイン、メピバカイン、ブピバカイン、オキセザゼイン。リドカインと似た作用時間。名前に濁音あり。" },
            { name: "ブピバカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、長時間作用型(3-5時間)、血管収縮薬なしでも作用時間長い、心毒性に注意", applications: "脊椎麻酔、伝達麻酔、硬膜外麻酔", category: "局所麻酔薬", subCategory: "アミド型局所麻酔薬", memo: "アミド型→濁点「゛」がつく。リドカイン、ジブカイン、メピバカイン、ブピバカイン、オキセザゼイン。「ブピ」っと太く長く効くが、心「毒」性「高」。名前に濁音「ブ」「ピ」「バ」あり。" },
            { name: "プリロカイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、中時間作用型、メトヘモグロビン血症に注意", applications: "浸潤麻酔、伝達麻酔、歯科領域の浸潤麻酔", category: "局所麻酔薬", subCategory: "アミド型局所麻酔薬", memo: "【アミド型】だが「濁音なし」の例外。メトヘモグロビン血症の副作用に注意。" },
            { name: "オキセサゼイン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断", characteristics: "アミド型、強酸性下でも作用、胃粘膜局所麻酔薬、ガストリン遊離抑制", applications: "食道炎・胃炎・胃潰瘍等の疼痛・嘔吐・げっぷ等", category: "局所麻酔薬", subCategory: "その他麻酔薬", memo: "アミド型→濁点「゛」がつく。リドカイン、ジブカイン、メピバカイン、ブピバカイン、オキセザゼイン。" },
            // 末梢性筋弛緩薬
            { name: "ツボクラリン", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "d-ツボクラリン、矢毒クラーレ主成分。ヒスタミン遊離作用、自律神経節遮断作用。現在使用されていない。", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "ガラミン", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "Daniel Bovet開発。ツボクラリンより弱い。ヒスタミン遊離作用なし。心臓副交感神経遮断で血圧・心拍数上昇。現在使用されていない。", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "パンクロニウム", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "非脱分極性筋弛緩。ステロイド骨格。ツボクラリンより強力。作用時間長い。ヒスタミン遊離・自律神経節遮断作用弱い。現在使用されていない。", applications: "（歴史的）筋弛緩薬", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "ベクロニウム", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "非脱分極性筋弛緩。ステロイド骨格。ヒスタミン遊離作用弱い。作用時間約1時間。", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "ロクロニウム", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、ステロイド骨格、作用発現速い、スガマデクスで拮抗", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "ベシル酸シスアトラクリウム", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体競合的遮断", characteristics: "非脱分極性筋弛緩、アトラクリウムの異性体、ホフマン分解、副作用少ない", applications: "全身麻酔時の筋弛緩", category: "末梢性筋弛緩薬", subCategory: "競合的遮断薬", memo: "" },
            { name: "スキサメトニウム", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体刺激(持続的脱分極)", characteristics: "脱分極性筋弛緩。アセチルコリン2分子結合構造。血漿ChEで分解されるため作用時間が短い(約5分)。悪性高熱症・緑内障に禁忌。", applications: "麻酔時の筋弛緩、気管内挿管時の筋弛緩", category: "末梢性筋弛緩薬", subCategory: "脱分極性遮断薬", memo: "サクシニルコリンとも。作用発現が速いが、拮抗薬がない。" },
            { name: "ダントロレン", mechanism: "筋小胞体リアノジン受容体(Ca<sup>2+</sup>遊離チャネル)抑制", characteristics: "骨格筋の興奮収縮連関を抑制、骨格筋直接電気刺激による収縮も抑制", applications: "悪性高熱症、悪性症候群、痙性麻痺", category: "末梢性筋弛緩薬", subCategory: "その他末梢性筋弛緩薬", memo: "悪性高熱症の特効薬。" },
            { name: "ボツリヌス毒素A型", mechanism: "アセチルコリン遊離抑制 (神経終末)", characteristics: "ボツリヌス菌産生毒素、効果3-4ヶ月持続", applications: "眼瞼痙攣、片側顔面痙攣、痙性斜頸、表情皺(眉間・目尻)", category: "末梢性筋弛緩薬", subCategory: "その他末梢性筋弛緩薬", memo: "" },
            { name: "エドロホニウム", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "抗コリンエステラーゼ作用。骨格筋直接刺激作用。作用持続時間非常に短い。", applications: "重症筋無力症の診断", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。テンシロンテストに使用。" },
            { name: "ネオスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成された可逆的コリンエステラーゼ阻害薬", applications: "重症筋無力症、クラーレ剤による呼吸抑制", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。" },
            { name: "ジスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成された可逆的コリンエステラーゼ阻害薬", applications: "重症筋無力症", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。" },
            { name: "ピリドスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成された可逆的コリンエステラーゼ阻害薬", applications: "重症筋無力症", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。" },
            { name: "アンベノニウム", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "合成された可逆的コリンエステラーゼ阻害薬", applications: "重症筋無力症", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。" },
            { name: "フィゾスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "現在は使用されていない。", applications: "重症筋無力症", category: "末梢性筋弛緩薬", subCategory: "抗クラーレ薬", memo: "抗クラーレ薬＝神経筋接合部刺激薬。" },
            { name: "アドレナリン", mechanism: "アドレナリン受容体(α,β)直接刺激", characteristics: "心機能亢進、血管収縮(α)/拡張(β<sub>2</sub>)、気管支拡張(β<sub>2</sub>)", applications: "アナフィラキシー、心停止、気管支喘息", category: "交感神経様作動薬", subCategory: "アドレナリンα/β受容体刺激薬", memo: "" },
            { name: "エチレフリン", mechanism: "α作用とβ作用を示す", characteristics: "COMTによる代謝を受けにくいため、経口投与可能で、作用は持続性。", applications: "本態性・起立性低血圧症、急性低血圧・ショック時の補助治療", category: "交感神経様作動薬", subCategory: "アドレナリンα/β受容体刺激薬", memo: "" },
            { name: "ナファゾリン", mechanism: "α<sub>1</sub>受容体直接刺激薬", characteristics: "細動脈血管の収縮", applications: "表在性充血(眼)、鼻粘膜充血(点鼻)、上気道粘膜の表面麻酔配合剤", category: "交感神経様作動薬", subCategory: "アドレナリンα<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "フェニレフリン", mechanism: "α<sub>1</sub>受容体直接刺激薬", characteristics: "血管収縮、瞳孔散大筋の収縮", applications: "急性低血圧・ショック時の補助治療、散瞳薬、局所麻酔薬の配合剤", category: "交感神経様作動薬", subCategory: "アドレナリンα<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "ミドドリン", mechanism: "α<sub>1</sub>受容体直接刺激薬（活性代謝物を介して）", characteristics: "脱グリシン化を経て活性代謝物デスグリミドドリンとなるプロドラッグ。", applications: "本態性低血圧症、起立性低血圧症", category: "交感神経様作動薬", subCategory: "アドレナリンα<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "メトキサミン", mechanism: "α<sub>1</sub>受容体直接刺激薬", characteristics: "末梢血管抵抗を増大させて、昇圧させる。", applications: "低血圧", category: "交感神経様作動薬", subCategory: "アドレナリンα<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "イソプレナリン", mechanism: "非選択的β受容体直接刺激 (β<sub>1</sub>及びβ<sub>2</sub>作用)", characteristics: "α作用はない。心機能亢進作用(β<sub>1</sub>)、気管支拡張作用(β<sub>2</sub>)、血管拡張作用(β<sub>2</sub>)", applications: "気管支ぜん息、急性・慢性気管支炎に伴う気管支痙攣の緩解", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>1</sub>/β<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "イソクスプリン", mechanism: "β<sub>2</sub>受容体刺激による血管拡張・子宮弛緩", characteristics: "血管拡張作用(β<sub>2</sub>)。子宮弛緩作用(β<sub>2</sub>)。", applications: "末梢循環障害、切迫流産・早産(子宮収縮の抑制)", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>1</sub>/β<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "ドブタミン", mechanism: "β<sub>1</sub>受容体直接刺激薬", characteristics: "合成カテコールアミン、心筋収縮力を増強する", applications: "急性循環不全における心筋収縮力の増強", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "デノパミン", mechanism: "β<sub>1</sub>受容体直接刺激薬", characteristics: "非カテコールアミン、経口投与可能、心筋収縮力を増強する", applications: "慢性心不全", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>1</sub>受容体刺激薬", memo: "" },
            { name: "サルブタモール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第二世代のβ<sub>2</sub>作用薬、中時間作用型、気管支拡張", applications: "気管支ぜん息、急性・慢性気管支炎、肺気腫", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "副作用: 手指振戦、心悸亢進、低カリウム血症。" },
            { name: "テルブタリン", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第二世代のβ<sub>2</sub>選択的作動薬。中時間型。", applications: "気管支ぜん息など", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "副作用: 手指振戦、心悸亢進、低カリウム血症。" },
            { name: "クレンブテロール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "気管支平滑筋の弛緩、排尿筋弛緩", applications: "気管支ぜん息、急性・慢性気管支炎、肺気腫、腹圧性尿失禁", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "副作用: 手指振戦、心悸亢進、低カリウム血症。" },
            { name: "リトドリン", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "子宮平滑筋β<sub>2</sub>受容体に選択性が高い、子宮弛緩", applications: "切迫流産・早産", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "副作用: 手指振戦、心悸亢進、低カリウム血症。" },
            { name: "フェノテロール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第三世代のβ<sub>2</sub>作用薬。長時間型。", applications: "気管支ぜん息、急性・慢性気管支炎、肺気腫", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "プロカテロール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第三世代のβ<sub>2</sub>選択的作動薬。長時間型。", applications: "気管支ぜん息、急性・慢性気管支炎、肺気腫", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "サルメテロール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第三世代のβ<sub>2</sub>選択的作動薬。長時間作用型の吸入薬。", applications: "気管支ぜん息の予防、慢性閉塞性肺疾患(COPD)", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "ツロブテロール", mechanism: "選択的β<sub>2</sub>受容体刺激薬", characteristics: "第三世代のβ<sub>2</sub>選択的作動薬。長時間型(貼付剤の場合)。", applications: "気管支ぜん息、急性・慢性気管支炎、肺気腫", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>2</sub>受容体刺激薬", memo: "" },
            { name: "ミラベグロン", mechanism: "選択的β<sub>3</sub>受容体刺激薬", characteristics: "膀胱平滑筋のβ<sub>3</sub>受容体を刺激し、膀胱を弛緩させることで、畜尿機能を亢進する。", applications: "過活動膀胱における尿意切迫感、頻尿、切迫性尿失禁", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>3</sub>受容体刺激薬", memo: "" },
            { name: "ビベグロン", mechanism: "選択的β<sub>3</sub>受容体刺激薬", characteristics: "膀胱平滑筋のβ<sub>3</sub>受容体を刺激し、膀胱を弛緩させることで、畜尿機能を亢進する。", applications: "過活動膀胱における尿意切迫感、頻尿、切迫性尿失禁", category: "交感神経様作動薬", subCategory: "アドレナリンβ<sub>3</sub>受容体刺激薬", memo: "" },
            { name: "チラミン", mechanism: "間接型アドレナリン作動薬", characteristics: "ノルアドレナリン遊離促進、MAOにより作用消失。タキフィラキシーを起こす。", applications: "医薬品ではない (チーズ、赤ワイン等に含有)", category: "交感神経様作動薬", subCategory: "間接型アドレナリン作動薬", memo: "" },
            { name: "アンフェタミン", mechanism: "間接型アドレナリン作動薬", characteristics: "ノルアドレナリン遊離を促進。タキフィラキシーを起こす。大脳皮質興奮作用が強い。覚せい剤指定。", applications: "ナルコレプシーなど（現在は使用制限）", category: "交感神経様作動薬", subCategory: "間接型アドレナリン作動薬", memo: "" },
            { name: "メタンフェタミン", mechanism: "間接型アドレナリン作動薬", characteristics: "ノルアドレナリン・ドパミン遊離促進、覚せい剤、精神依存・耐性強い", applications: "ナルコレプシー、麻酔からの覚醒促進", category: "交感神経様作動薬", subCategory: "間接型アドレナリン作動薬", memo: "" },
            { name: "エフェドリン", mechanism: "混合型アドレナリン作動薬 (直接αβ刺激＋NA遊離促進)", characteristics: "MAOやCOMTで分解されない、中枢興奮作用、経口投与可能", applications: "気管支喘息、低血圧、鼻閉", category: "交感神経様作動薬", subCategory: "混合型アドレナリン作動薬", memo: "" },
            { name: "メチルエフェドリン", mechanism: "混合型アドレナリン作動薬", characteristics: "エフェドリンのメチル化体。中枢興奮作用はエフェドリンより弱い。", applications: "気管支ぜん息、咳嗽", category: "交感神経様作動薬", subCategory: "混合型アドレナリン作動薬", memo: "" },
            { name: "ドパミン", mechanism: "混合型アドレナリン作動薬", characteristics: "内因性カテコールアミン。用量依存的に作用が変化(D<sub>1</sub>→β<sub>1</sub>→α<sub>1</sub>)。", applications: "急性循環不全、心原性ショック、出血性ショック", category: "交感神経様作動薬", subCategory: "混合型アドレナリン作動薬", memo: "" },
            { name: "ドカルパミン", mechanism: "ドパミンのプロドラッグ", characteristics: "体内でドパミンに変換されて作用を示す。", applications: "急性循環不全などドパミンの適応に準じる（経口投与可能な利点）", category: "交感神経様作動薬", subCategory: "その他のアドレナリン作動薬", memo: "" },
            { name: "アメジニウム", mechanism: "ノルアドレナリン再取り込み阻害作用とMAO阻害作用", characteristics: "交感神経終末へのノルアドレナリン再取り込み阻害作用とMAO阻害作用によって、交感神経機能を亢進する。", applications: "本態性低血圧症、起立性低血圧症", category: "交感神経様作動薬", subCategory: "その他のアドレナリン作動薬", memo: "" },
            { name: "トラゾリン", mechanism: "非選択的α受容体遮断薬 (イミダゾリン誘導体)", characteristics: "フェントラミンと同様の作用機序。", applications: "(歴史的) 褐色細胞腫など", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンα受容体遮断薬", memo: "現在使用されていない。" },
            { name: "エルゴタミン", mechanism: "α受容体遮断薬、5-HT<sub>1B/1D</sub>受容体作動薬", characteristics: "麦角アルカロイド。血管選択性 (α<sub>1</sub>/5-HT受容体の部分アゴニスト)。脳血管収縮作用。", applications: "片頭痛(発作時)、起立性低血圧症", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンα受容体遮断薬", memo: "" },
            { name: "ジベナミン", mechanism: "β-ハロアルキルアミン系α受容体遮断薬", characteristics: "受容体に共有結合し非可逆的に拮抗する。", applications: "レイノー病などの末梢循環障害の血行改善", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンα受容体遮断薬", memo: "" },
            { name: "フェノキシベンザミン", mechanism: "β-ハロアルキルアミン系α受容体遮断薬", characteristics: "受容体に共有結合し非可逆的に拮抗する。", applications: "レイノー病などの末梢循環障害の血行改善、褐色細胞腫", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンα受容体遮断薬", memo: "" },
            { name: "プロプラノロール", mechanism: "非選択的β受容体遮断", characteristics: "心拍数減少、血圧低下、気管支収縮", applications: "高血圧、狭心症、不整脈", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンβ受容体遮断薬", memo: "" },
            { name: "ピンドロール", mechanism: "非選択的β受容体遮断薬 (ISA+)", characteristics: "弱いβ受容体刺激作用(ISA)を併せもつ。", applications: "高血圧症、狭心症、頻脈性不整脈", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンβ受容体遮断薬", memo: "" },
            { name: "チモロール", mechanism: "非選択的β受容体遮断薬 (ISA-)", characteristics: "内因性交感神経刺激作用(ISA)無し。効力が強い。眼房水の産生抑制。", applications: "緑内障、高眼圧症、(高血圧、狭心症)", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンβ受容体遮断薬", memo: "" },
            { name: "カルテオロール", mechanism: "非選択的β受容体遮断薬（ISA+）", characteristics: "眼房水の産生抑制。ISA(+)。", applications: "緑内障、高眼圧症", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンβ受容体遮断薬", memo: "" },
            { name: "レボブノロール", mechanism: "非選択的β受容体遮断薬", characteristics: "眼房水の産生抑制。ISA(-)", applications: "緑内障、高眼圧症", category: "交感神経遮断薬", subCategory: "非選択的アドレナリンβ受容体遮断薬", memo: "" },
            { name: "アテノロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬", characteristics: "β<sub>2</sub>受容体遮断作用は非常に弱い。ISAなし。", applications: "狭心症(労作型狭心症の第一選択薬)、不整脈(第Ⅱ群)、本態性高血圧症", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "メトプロロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬", characteristics: "β<sub>2</sub>受容体遮断作用は非常に弱い。ISAなし。", applications: "狭心症(労作型狭心症の第一選択薬)、不整脈(第Ⅱ群)、本態性高血圧症", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "ビソプロロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬", characteristics: "β<sub>2</sub>受容体遮断作用は非常に弱い。ISAなし。", applications: "狭心症(労作型狭心症の第一選択薬)、不整脈(第Ⅱ群)、本態性高血圧症、慢性心不全", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "セリプロロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬 (ISA+)", characteristics: "弱いβ<sub>1</sub>受容体刺激作用(ISA)を併せもつ。一部β<sub>2</sub>刺激作用もあるとされる。", applications: "本態性高血圧症、腎実質性高血圧症、狭心症", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "ベタキソロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬 (ISA-)", characteristics: "眼房水の産生抑制。", applications: "高血圧症、腎実質性高血圧症、狭心症、緑内障", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "エスモロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬 (ISA-)", characteristics: "超短時間作用型。エステラーゼで分解される。", applications: "上室性頻脈性不整脈(手術時)", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "ランジオロール", mechanism: "選択的β<sub>1</sub>受容体遮断薬 (ISA-)", characteristics: "短時間作用型。エスモロールと同様。", applications: "上室性頻脈性不整脈(手術時)", category: "交感神経遮断薬", subCategory: "選択的アドレナリンβ<sub>1</sub>受容体遮断薬", memo: "" },
            { name: "ラベタロール", mechanism: "非選択的β受容体遮断薬 (α<sub>1</sub>遮断作用も)", characteristics: "ISAをわずかに有する。血管α<sub>1</sub>受容体遮断により血管拡張、血圧降下。", applications: "本態性高血圧症(高血圧救急症も)、狭心症", category: "交感神経遮断薬", subCategory: "アドレナリンα/β受容体遮断薬", memo: "" },
            { name: "カルベジロール", mechanism: "非選択的β受容体遮断薬 (α<sub>1</sub>遮断作用も)", characteristics: "抗酸化作用。血管拡張作用。血圧低下による反射性頻脈は起こらない。", applications: "本態性高血圧症、腎実質性高血圧症、狭心症、慢性心不全", category: "交感神経遮断薬", subCategory: "アドレナリンα/β受容体遮断薬", memo: "" },
            { name: "アモスラロール", mechanism: "α<sub>1</sub>/β受容体遮断薬", characteristics: "血管α<sub>1</sub>受容体の遮断により血管拡張、血圧降下。心臓β<sub>1</sub>受容体を遮断し心拍出量減少。", applications: "本態性高血圧症", category: "交感神経遮断薬", subCategory: "アドレナリンα/β受容体遮断薬", memo: "" },
            { name: "アロチノロール", mechanism: "α<sub>1</sub>/β受容体遮断薬", characteristics: "血管α<sub>1</sub>受容体の遮断により血管拡張、血圧降下。ISA（-）。", applications: "本態性高血圧症、狭心症、頻脈性不整脈", category: "交感神経遮断薬", subCategory: "アドレナリンα/β受容体遮断薬", memo: "" },
            { name: "ニプラジロール", mechanism: "非選択的β受容体遮断薬 (α<sub>1</sub>遮断作用も, ISA-)", characteristics: "NO遊離作用。ニトロ基を持つ。眼房水産生抑制。", applications: "高血圧症、狭心症、緑内障", category: "交感神経遮断薬", subCategory: "アドレナリンα/β受容体遮断薬", memo: "" },
            { name: "メチルドパ", mechanism: "中枢性α₂受容体刺激薬 (活性代謝物を介して)", characteristics: "プロドラッグ。α-メチルノルアドレナリンが延髄血管運動中枢のα₂受容体を刺激し、中枢性に交感神経緊張を低下させる。", applications: "高血圧症(妊娠高血圧症の第一選択薬)", category: "交感神経遮断薬", subCategory: "ノルアドレナリン生合成阻害薬", memo: "" },
            { name: "レセルピン", mechanism: "ノルアドレナリン枯渇薬", characteristics: "不可逆的に小胞モノアミントランスポーター(VMAT)を阻害し、ノルアドレナリンを枯渇させる。", applications: "本態性・腎性・悪性高血圧症", category: "交感神経遮断薬", subCategory: "ノルアドレナリン枯渇薬", memo: "" },
            { name: "グアネチジン", mechanism: "ノルアドレナリン遊離阻害薬", characteristics: "交感神経に取り込まれ、ノルアドレナリンの遊離を阻害し、後に枯渇させる。", applications: "(歴史的) 高血圧症", category: "交感神経遮断薬", subCategory: "ノルアドレナリン遊離阻害薬", memo: "" },
            { name: "ブリモニジン", mechanism: "α<sub>2</sub>受容体刺激薬", characteristics: "眼房水の産生抑制・排出促進。", applications: "緑内障、高眼圧症", category: "交感神経遮断薬", subCategory: "緑内障治療薬", memo: "" },
            { name: "アセチルコリン", mechanism: "ムスカリン受容体刺激、ニコチン受容体刺激", characteristics: "神経伝達物質、コリンエステラーゼで分解", applications: "神経伝達、血管拡張", category: "その他", subCategory: "神経伝達物質", memo: "" },
            { name: "フィゾスチグミン", mechanism: "可逆的コリンエステラーゼ阻害", characteristics: "カラバル豆アルカロイド。3級アミンで血液脳関門通過。現在使用されていない。", applications: "（歴史的）抗コリン薬中毒の解毒", category: "その他", subCategory: "コリンエステラーゼ阻害薬", memo: "" }, 
            { name: "スガマデクス", mechanism: "ロクロニウム・ベクロニウムを包接化し不活性化", characteristics: "修飾γシクロデキストリン、筋弛緩回復薬", applications: "ロクロニウム・ベクロニウムによる筋弛緩からの回復", category: "その他", subCategory: "筋弛緩回復薬", memo: "" },
            { name: "テトロドトキシン", mechanism: "電位依存性Na<sup>+</sup>チャネル遮断 (細胞外から蓋をする)", characteristics: "フグ毒、Na<sup>+</sup>チャネル選択性高い、強力な局所麻酔作用だが臨床応用なし", applications: "薬理学的試薬", category: "その他", subCategory: "神経毒", memo: "" },
            { name: "α-ブンガロトキシン", mechanism: "ニコチン性アセチルコリン(N<sub>M</sub>)受容体非競合的・不可逆的遮断", characteristics: "ヘビ毒の一種", applications: "研究用試薬", category: "その他", subCategory: "神経毒", memo: "" },
            { name: "パパベリン", mechanism: "ホスホジエステラーゼ阻害", characteristics: "平滑筋弛緩作用、血管拡張作用", applications: "血管拡張、鎮痙", category: "その他", subCategory: "血管拡張薬", memo: "" },
            { name: "ニフェジピン", mechanism: "Ca<sup>2+</sup>チャネル遮断 (L型)", characteristics: "血管拡張、血圧低下、ジヒドロピリジン系", applications: "高血圧、狭心症", category: "その他", subCategory: "Ca拮抗薬", memo: "" },
            { name: "ジアゼパム", mechanism: "GABA<sub>A</sub>受容体アロステリック修飾 (ベンゾジアゼピン結合部位)", characteristics: "抗不安、筋弛緩、抗痙攣", applications: "不安障害、てんかん、筋痙攣", category: "その他", subCategory: "抗不安薬・抗けいれん薬", memo: "" }
        ];

        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let answerMode = 'multiple-choice'; 
        let isReviewMode = false; 
        let reviewSourceQuestions = []; 

        const questionElement = document.getElementById('question');
        const optionsElement = document.getElementById('options');
        const typedAnswerContainer = document.getElementById('typed-answer-container');
        const typedAnswerInput = document.getElementById('typed-answer-input');
        const submitTypedAnswerBtn = document.getElementById('submit-typed-answer-btn');
        const explanationElement = document.getElementById('explanation');
        const feedbackElement = document.getElementById('feedback');
        const nextButton = document.getElementById('next-btn');
        const prevButton = document.getElementById('prev-btn');
        const finishButton = document.getElementById('finish-btn');
        const quizContainer = document.getElementById('quiz-container');
        const summaryContainer = document.getElementById('summary-container');
        const correctCountElement = document.getElementById('correct-count');
        const totalQuestionsElement = document.getElementById('total-questions');
        const accuracyElement = document.getElementById('accuracy');
        const restartButton = document.getElementById('restart-btn');
        const categorySelectContainer = document.getElementById('category-select-container');
        const categoryCheckboxesContainer = document.getElementById('category-checkboxes-container');
        const numQuestionsSelect = document.getElementById('num-questions-select');
        const startQuizButton = document.getElementById('start-quiz-btn');
        const progressBar = document.getElementById('progress-bar');
        const questionCounterElement = document.getElementById('question-counter');
        const subCategoryDisplay = document.getElementById('sub-category-display');
        const reviewIncorrectContainer = document.getElementById('review-incorrect-container');
        const reviewOptionsContainer = document.getElementById('review-options-container');
        const backToMenuButton = document.getElementById('back-to-menu-btn');
        const reviewIncorrectBtn = document.getElementById('review-incorrect-btn'); 
        const quizCardElement = document.getElementById('quiz-card-element'); 
        const quizCardContent = document.getElementById('quiz-card-content'); 
        const mainHeader = document.getElementById('main-header'); 

        let touchstartX = 0;
        let touchendX = 0;
        const swipeThreshold = 50; 
        let isAnimating = false; 
        
        const categories = [...new Set(drugData.map(d => d.category))].filter(Boolean);

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        
        function updateNumQuestionsOptions() {
            const selectedCategories = getSelectedCategories();
            let availableQuestions = drugData;
            if (selectedCategories.length > 0 && !document.getElementById('category-all').checked) {
                availableQuestions = drugData.filter(drug => selectedCategories.includes(drug.category));
            }
            const count = availableQuestions.length;

            numQuestionsSelect.innerHTML = ''; 
            
            const questionOptions = [5, 10, 15, 20, 30, 50]; 
            questionOptions.forEach(num => {
                if (count >= num) {
                    const option = document.createElement('option');
                    option.value = num;
                    option.textContent = `${num}問`;
                    numQuestionsSelect.appendChild(option);
                }
            });
            const allOption = document.createElement('option');
            allOption.value = 'all';
            allOption.textContent = `全ての問題 (${count}問)`;
            numQuestionsSelect.appendChild(allOption);

            if (count >= 10) {
                 numQuestionsSelect.value = '10';
            } else if (count >=5) {
                 numQuestionsSelect.value = '5';
            } else {
                 numQuestionsSelect.value = 'all';
            }
        }
        
        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('#category-checkboxes-container input[type="checkbox"]:not(#category-all)');
            const selected = [];
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.value);
                }
            });
            return selected;
        }

        function initializeQuizData(selectedCategories, numQuestionsRequestedStr, mode) { 
            isReviewMode = false; 
            answerMode = mode; 
            let filteredDrugs;

            if (selectedCategories.includes('all')) {
                filteredDrugs = [...drugData];
            } else {
                filteredDrugs = drugData.filter(drug => selectedCategories.includes(drug.category));
            }

            if (filteredDrugs.length === 0) {
                alert("クイズを開始するには、少なくとも1つのカテゴリーを選択してください。");
                mainHeader.style.display = 'block'; 
                return false;
            }
            
            shuffleArray(filteredDrugs);
            
            let numToDisplay;
            if (numQuestionsRequestedStr === 'all') {
                numToDisplay = filteredDrugs.length;
            } else {
                const requestedNum = parseInt(numQuestionsRequestedStr);
                numToDisplay = Math.min(requestedNum, filteredDrugs.length);
            }
            
            if (numToDisplay === 0 && filteredDrugs.length > 0) {
                numToDisplay = filteredDrugs.length; 
            }

            const selectedQuizDrugs = filteredDrugs.slice(0, numToDisplay);
            generateQuestionsFromSource(selectedQuizDrugs); 
            
            if (quizQuestions.length === 0) {
                 alert("クイズの問題を生成できませんでした。出題数を調整するか、カテゴリーを変更してください。");
                 mainHeader.style.display = 'block'; 
                 return false;
            }
            return true;
        }

        // [CHANGE] Logic for generating distractors updated
        function generateQuestionsFromSource(sourceDrugArray) {
            quizQuestions = sourceDrugArray.map(correctDrug => {
                const questionText = `
                    <div class="text-left space-y-3 mb-4"> 
                        <div class="question-detail-box bg-sky-50"> 
                            <strong>作用機序:</strong>
                            <div>${correctDrug.mechanism}</div>
                        </div>
                        <div class="question-detail-box bg-emerald-50"> 
                            <strong>薬理学的特徴:</strong>
                            <div>${correctDrug.characteristics}</div>
                        </div>
                        <div class="question-detail-box bg-amber-50"> 
                            <strong>主な適応:</strong>
                            <div>${correctDrug.applications}</div>
                        </div>
                    </div>
                    <p class="question-prompt"><strong>この説明に該当する薬物はどれですか？</strong></p>`;
                
                let optionsArray = [];
                if (answerMode === 'multiple-choice') { 
                    const distractorCategory = correctDrug.category;
                    
                    let distractors = drugData
                        .filter(d => d.category === distractorCategory && d.name !== correctDrug.name)
                        .map(d => d.name);
                    
                    shuffleArray(distractors);

                    let finalDistractors = distractors.slice(0, 3);
                    
                    if (finalDistractors.length < 3) {
                        let fallbackDistractors = drugData
                            .filter(d => d.name !== correctDrug.name && !finalDistractors.includes(d.name))
                            .map(d => d.name);
                        shuffleArray(fallbackDistractors);
                        const needed = 3 - finalDistractors.length;
                        finalDistractors.push(...fallbackDistractors.slice(0, needed));
                    }

                    optionsArray = [correctDrug.name, ...finalDistractors];
                    shuffleArray(optionsArray);
                }
                
                let explanationContent = `<strong>${correctDrug.name}</strong><br>作用機序: ${correctDrug.mechanism}<br>薬理学的特徴: ${correctDrug.characteristics}<br>主な適応: ${correctDrug.applications}`;
                if (correctDrug.memo) {
                    explanationContent += `<div class="memo-point"><strong>暗記ポイント・比較:</strong><br>${correctDrug.memo}</div>`;
                }

                return {
                    questionText: questionText,
                    options: optionsArray, 
                    correctAnswer: correctDrug.name,
                    explanationText: explanationContent, 
                    drugDetails: correctDrug 
                };
            });
        }
        
        function animateAndLoadQuestion(newIndex, direction) {
            if (isAnimating) return; 
            isAnimating = true;

            quizCardContent.style.opacity = '0';
            if (direction === 'next') {
                quizCardContent.style.transform = 'translateX(-100%)'; 
            } else { 
                quizCardContent.style.transform = 'translateX(100%)'; 
            }

            setTimeout(() => {
                loadQuestion(newIndex); 
                
                quizCardContent.style.transition = 'none'; 
                if (direction === 'next') {
                    quizCardContent.style.transform = 'translateX(100%)';
                } else { 
                    quizCardContent.style.transform = 'translateX(-100%)';
                }
                
                quizCardContent.offsetHeight; 

                quizCardContent.style.transition = 'transform 0.35s ease-in-out, opacity 0.35s ease-in-out';
                quizCardContent.style.opacity = '1';
                quizCardContent.style.transform = 'translateX(0)';

                setTimeout(() => {
                    isAnimating = false;
                }, 350); 

            }, 350); 
        }


        function loadQuestion(index) {
            if (index < 0 || index >= quizQuestions.length) return;

            currentQuestionIndex = index;
            const questionData = quizQuestions[index];
            
            if (questionData.drugDetails.subCategory) {
                subCategoryDisplay.innerHTML = questionData.drugDetails.subCategory;
                subCategoryDisplay.style.display = 'inline-block';
            } else {
                subCategoryDisplay.style.display = 'none';
            }

            questionElement.innerHTML = questionData.questionText;
            
            optionsElement.innerHTML = ''; 
            typedAnswerInput.value = ''; 
            typedAnswerInput.classList.remove('border-green-500', 'ring-2', 'ring-green-200', 'border-red-500', 'ring-2', 'ring-red-200');

            if (answerMode === 'multiple-choice') { 
                optionsElement.style.display = 'flex';
                typedAnswerContainer.style.display = 'none';
                questionData.options.forEach((optionName) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.classList.add('option');
                    optionDiv.textContent = optionName;
                    optionDiv.dataset.optionName = optionName; 
                    optionDiv.addEventListener('click', () => selectOption(optionDiv, questionData));
                    optionsElement.appendChild(optionDiv);
                });
            } else { 
                optionsElement.style.display = 'none';
                typedAnswerContainer.style.display = 'block';
                typedAnswerInput.disabled = false;
                submitTypedAnswerBtn.disabled = false;
                typedAnswerInput.focus();
            }

            explanationElement.style.display = 'none';
            feedbackElement.style.display = 'none';
            feedbackElement.textContent = '';
            feedbackElement.className = 'feedback';

            const answered = userAnswers[index];
            if (answered) {
                if (answerMode === 'multiple-choice') {
                    optionsElement.childNodes.forEach(optDiv => {
                        optDiv.classList.add('answered', 'disabled');
                        if (optDiv.dataset.optionName === questionData.correctAnswer) {
                            optDiv.classList.add('correct');
                        } else if (optDiv.dataset.optionName === answered.selectedDrugName) {
                            optDiv.classList.add('incorrect');
                        }
                    });
                } else { 
                    typedAnswerInput.value = answered.typedAnswer || ''; 
                    typedAnswerInput.disabled = true;
                    submitTypedAnswerBtn.disabled = true;
                    if(answered.isCorrect) {
                        typedAnswerInput.classList.add('border-green-500', 'ring-2', 'ring-green-200');
                    } else {
                        typedAnswerInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    }
                }
                feedbackElement.textContent = answered.isCorrect ? '正解です！' : `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add(answered.isCorrect ? 'correct' : 'incorrect');
                feedbackElement.style.display = 'block';
                explanationElement.innerHTML = questionData.explanationText;
                explanationElement.style.display = 'block';
                nextButton.disabled = false;
            } else {
                nextButton.disabled = true;
            }

            const progressPercentage = quizQuestions.length > 0 ? ((index + 1) / quizQuestions.length) * 100 : 0;
            progressBar.style.width = `${progressPercentage}%`;
            if (isReviewMode) {
                questionCounterElement.textContent = quizQuestions.length > 0 ? `復習問題 ${index + 1} / ${quizQuestions.length}` : '復習問題 0 / 0';
            } else {
                questionCounterElement.textContent = quizQuestions.length > 0 ? `問題 ${index + 1} / ${quizQuestions.length}` : '問題 0 / 0';
            }

            prevButton.disabled = index === 0;
            if (index === quizQuestions.length - 1) {
                nextButton.style.display = 'none';
                finishButton.style.display = 'inline-block';
                finishButton.disabled = !answered; 
            } else {
                nextButton.style.display = 'inline-block';
                finishButton.style.display = 'none';
            }
            if (quizQuestions.length === 0) {
                nextButton.style.display = 'none';
                finishButton.style.display = 'none';
                prevButton.disabled = true;
            }
        }

        function selectOption(selectedOptionDiv, questionData) {
            if (userAnswers[currentQuestionIndex]) return; 

            const selectedDrugName = selectedOptionDiv.dataset.optionName;
            const isCorrect = selectedDrugName === questionData.correctAnswer;

            userAnswers[currentQuestionIndex] = {
                questionIndex: currentQuestionIndex,
                selectedDrugName: selectedDrugName, 
                typedAnswer: null, 
                correctAnswerName: questionData.correctAnswer,
                isCorrect: isCorrect,
                questionText: questionData.questionText,
                explanationText: questionData.explanationText,
                drugDetails: questionData.drugDetails 
            };

            if (isCorrect) {
                if(!isReviewMode) score++;
                selectedOptionDiv.classList.add('correct');
                feedbackElement.textContent = '正解です！';
                feedbackElement.classList.add('correct');
            } else {
                selectedOptionDiv.classList.add('incorrect');
                feedbackElement.textContent = `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add('incorrect');
                optionsElement.childNodes.forEach(optDiv => {
                    if (optDiv.dataset.optionName === questionData.correctAnswer) {
                        optDiv.classList.add('correct');
                    }
                });
            }

            feedbackElement.style.display = 'block';
            explanationElement.innerHTML = questionData.explanationText;
            explanationElement.style.display = 'block';

            optionsElement.childNodes.forEach(optDiv => {
                optDiv.classList.add('disabled', 'answered');
            });

            nextButton.disabled = false;
            if (currentQuestionIndex === quizQuestions.length - 1) {
                finishButton.disabled = false;
            }
        }

        function submitTypedAnswer() {
            if (userAnswers[currentQuestionIndex]) return; 

            const questionData = quizQuestions[currentQuestionIndex];
            const userAnswerText = typedAnswerInput.value.trim();
            
            const normalizedUserAnswer = userAnswerText.toLowerCase().replace(/\s+/g, '');
            const normalizedCorrectAnswer = questionData.correctAnswer.toLowerCase().replace(/\s+/g, '');

            const isCorrect = normalizedUserAnswer === normalizedCorrectAnswer;

            userAnswers[currentQuestionIndex] = {
                questionIndex: currentQuestionIndex,
                selectedDrugName: null, 
                typedAnswer: userAnswerText, 
                correctAnswerName: questionData.correctAnswer,
                isCorrect: isCorrect,
                questionText: questionData.questionText,
                explanationText: questionData.explanationText,
                drugDetails: questionData.drugDetails
            };

            if (isCorrect) {
                if(!isReviewMode) score++;
                feedbackElement.textContent = '正解です！';
                feedbackElement.classList.add('correct');
                typedAnswerInput.classList.add('border-green-500', 'ring-2', 'ring-green-200'); 
            } else {
                feedbackElement.textContent = `不正解です。正解は「${questionData.correctAnswer}」です。`;
                feedbackElement.classList.add('incorrect');
                typedAnswerInput.classList.add('border-red-500', 'ring-2', 'ring-red-200'); 
            }

            feedbackElement.style.display = 'block';
            explanationElement.innerHTML = questionData.explanationText;
            explanationElement.style.display = 'block';

            typedAnswerInput.disabled = true;
            submitTypedAnswerBtn.disabled = true;

            nextButton.disabled = false;
            if (currentQuestionIndex === quizQuestions.length - 1) {
                finishButton.disabled = false;
            }
        }
        submitTypedAnswerBtn.addEventListener('click', submitTypedAnswer);
        typedAnswerInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !submitTypedAnswerBtn.disabled) {
                submitTypedAnswer();
            }
        });

        function showSummary() {
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                 quizContainer.style.display = 'none';
            }, 500); 

            summaryContainer.style.display = 'block'; 
            categorySelectContainer.style.display = 'none';
            mainHeader.style.display = isReviewMode ? 'block' : 'none'; 

            if (isReviewMode) {
                document.querySelector('#summary-container h2').textContent = '復習お疲れ様でした';
                document.querySelector('#summary-container p:nth-of-type(1)').style.display = 'none';
                document.querySelector('#summary-container p:nth-of-type(2)').style.display = 'none';
            } else {
                correctCountElement.textContent = score;
                totalQuestionsElement.textContent = quizQuestions.length;
                const accuracy = quizQuestions.length > 0 ? Math.round((score / quizQuestions.length) * 100) : 0;
                accuracyElement.textContent = accuracy;
            }
            
            reviewIncorrectContainer.innerHTML = '';
            reviewSourceQuestions = []; 
            const incorrectAnswersForDisplay = userAnswers.filter(ans => ans && !ans.isCorrect);
            
            if (incorrectAnswersForDisplay.length > 0) {
                const reviewTitle = document.createElement('h3');
                reviewTitle.textContent = '間違えた問題:';
                reviewTitle.className = 'text-xl font-bold mt-8 mb-4 text-left text-slate-800';
                reviewIncorrectContainer.appendChild(reviewTitle);

                const reviewGrid = document.createElement('div');
                reviewGrid.className = 'space-y-4';
                incorrectAnswersForDisplay.forEach(ans => {
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'p-4 border border-gray-200 rounded-lg bg-white shadow-sm text-left';
                    const userAnswerDisplay = ans.typedAnswer !== null ? (ans.typedAnswer || '(未入力)') : ans.selectedDrugName;
                    
                    const questionSummaryHtml = `
                        <div class="text-left space-y-2 text-sm">
                            <div class="p-2 border rounded-md bg-sky-50/50">
                                <strong class="text-xs text-sky-700">作用機序:</strong> <div class="text-gray-800">${ans.drugDetails.mechanism}</div>
                            </div>
                            <div class="p-2 border rounded-md bg-emerald-50/50">
                                <strong class="text-xs text-emerald-700">薬理学的特徴:</strong> <div class="text-gray-800">${ans.drugDetails.characteristics}</div>
                            </div>
                            <div class="p-2 border rounded-md bg-amber-50/50">
                                <strong class="text-xs text-amber-700">主な適応:</strong> <div class="text-gray-800">${ans.drugDetails.applications}</div>
                            </div>
                        </div>`;

                    reviewCard.innerHTML = `
                        <p class="font-bold text-slate-800 mb-2">Q. ${ans.questionIndex + 1}</p>
                        ${questionSummaryHtml}
                        <p class="mt-3 text-sm"><span class="font-semibold">あなたの答え:</span> <span class="text-red-600 font-bold">${userAnswerDisplay}</span></p>
                        <details class="mt-3 text-sm">
                            <summary class="cursor-pointer text-blue-600 hover:underline font-medium">正答と解説を確認</summary>
                            <div class="mt-2 pt-2 border-t text-left">
                                <p class="font-semibold">正解: <span class="text-green-700 font-bold">${ans.correctAnswerName}</span></p>
                                <div class="mt-1 p-3 bg-blue-50 border-blue-100 rounded-md text-xs text-gray-700">${ans.explanationText}</div>
                            </div>
                        </details>`;
                    reviewGrid.appendChild(reviewCard);

                    if (!reviewSourceQuestions.some(rq => rq.name === ans.drugDetails.name)) {
                        reviewSourceQuestions.push(ans.drugDetails);
                    }
                });
                reviewIncorrectContainer.appendChild(reviewGrid);
                reviewIncorrectBtn.style.display = 'inline-block'; 
                reviewOptionsContainer.style.display = 'block';
                reviewIncorrectBtn.disabled = false;
            } else if (userAnswers.length > 0 && userAnswers.every(a => a.isCorrect)) {
                const perfectMessage = document.createElement('p');
                perfectMessage.textContent = isReviewMode ? '全て復習できました！' : '全問正解です！素晴らしい！';
                perfectMessage.className = 'text-green-600 font-semibold mt-4 text-lg';
                reviewIncorrectContainer.appendChild(perfectMessage);
                reviewIncorrectBtn.style.display = 'none'; 
                reviewOptionsContainer.style.display = 'none';
            } else { 
                reviewIncorrectBtn.style.display = 'none';
                reviewOptionsContainer.style.display = 'none';
            }
        }
        
        function resetQuizState() {
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            quizQuestions = []; 
            progressBar.style.width = '0%';
            questionCounterElement.textContent = '';
            nextButton.style.display = 'inline-block';
            finishButton.style.display = 'none';
            nextButton.disabled = true;
            prevButton.disabled = true;
            isReviewMode = false; 
            typedAnswerInput.classList.remove('border-green-500', 'ring-2', 'ring-green-200', 'border-red-500', 'ring-2', 'ring-red-200');
            
            document.querySelector('#summary-container h2').textContent = 'あなたの成績';
            document.querySelector('#summary-container p:nth-of-type(1)').style.display = 'block';
            document.querySelector('#summary-container p:nth-of-type(2)').style.display = 'block';
        }

        function startReviewQuiz(reviewMode) {
            if (reviewSourceQuestions.length === 0) {
                alert("復習する問題がありません。");
                return;
            }
            isReviewMode = true;
            answerMode = reviewMode;
            
            currentQuestionIndex = 0;
            userAnswers = []; 
            quizQuestions = []; 
            progressBar.style.width = '0%';
            
            let reviewDrugsToQuiz = [...reviewSourceQuestions]; 
            shuffleArray(reviewDrugsToQuiz); 
            generateQuestionsFromSource(reviewDrugsToQuiz); 

            if (quizQuestions.length > 0) {
                categorySelectContainer.style.display = 'none';
                summaryContainer.style.display = 'none';
                
                quizContainer.style.display = 'block'; 
                setTimeout(() => { 
                    quizContainer.classList.add('visible');
                }, 10);

                mainHeader.style.display = 'none'; 
                
                quizCardContent.style.transition = 'none';
                quizCardContent.style.transform = 'translateX(0)'; 
                quizCardContent.style.opacity = '0'; 
                loadQuestion(0);
                setTimeout(() => { 
                    quizCardContent.style.transition = 'transform 0.35s ease-in-out, opacity 0.35s ease-in-out';
                    quizCardContent.style.opacity = '1';
                }, 20);
            } else {
                alert("復習問題の生成に失敗しました。");
                isReviewMode = false; 
                mainHeader.style.display = 'block'; 
            }
        }

        quizCardElement.addEventListener('touchstart', function(event) {
            if (isAnimating) return;
            touchstartX = event.changedTouches[0].screenX;
        }, {passive: true}); 

        quizCardElement.addEventListener('touchend', function(event) {
            if (isAnimating) return;
            touchendX = event.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            if (touchendX < touchstartX - swipeThreshold) {
                if (currentQuestionIndex < quizQuestions.length - 1) {
                    if (!nextButton.disabled) { 
                        animateAndLoadQuestion(currentQuestionIndex + 1, 'next');
                    }
                } else if (!finishButton.disabled && finishButton.style.display !== 'none') { 
                    finishButton.click(); 
                }
            }
            if (touchendX > touchstartX + swipeThreshold) {
                if (currentQuestionIndex > 0) {
                    animateAndLoadQuestion(currentQuestionIndex - 1, 'prev');
                }
            }
        }

        function populateCategories() {
            const container = document.createElement('div');
            container.className = 'checkbox-group';
            
            const allItem = document.createElement('div');
            allItem.className = 'checkbox-item';
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.id = 'category-all';
            allCheckbox.value = 'all';
            allCheckbox.checked = true;
            allItem.appendChild(allCheckbox);
            const allLabel = document.createElement('label');
            allLabel.htmlFor = 'category-all';
            allLabel.textContent = '全て';
            allItem.appendChild(allLabel);
            container.appendChild(allItem);

            categories.forEach(category => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `category-${category}`;
                checkbox.value = category;
                checkbox.checked = true;
                item.appendChild(checkbox);
                const label = document.createElement('label');
                label.htmlFor = `category-${category}`;
                label.textContent = category;
                item.appendChild(label);
                container.appendChild(item);
            });
            categoryCheckboxesContainer.appendChild(container);

            const allCatCheckbox = document.getElementById('category-all');
            const otherCheckboxes = document.querySelectorAll('#category-checkboxes-container input[type="checkbox"]:not(#category-all)');

            allCatCheckbox.addEventListener('change', () => {
                otherCheckboxes.forEach(checkbox => {
                    checkbox.checked = allCatCheckbox.checked;
                });
                updateNumQuestionsOptions();
            });

            otherCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const allChecked = [...otherCheckboxes].every(cb => cb.checked);
                    allCatCheckbox.checked = allChecked;
                    updateNumQuestionsOptions();
                });
            });
        }

        startQuizButton.addEventListener('click', () => {
            let selectedCategories = getSelectedCategories();
            if (document.getElementById('category-all').checked || selectedCategories.length === 0) {
                selectedCategories = ['all'];
            }
            const numQuestions = numQuestionsSelect.value; 
            const selectedMode = document.querySelector('input[name="answer-mode"]:checked').value;
            
            resetQuizState(); 
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'none'; 
            if (initializeQuizData(selectedCategories, numQuestions, selectedMode)) { 
                categorySelectContainer.style.display = 'none';
                
                quizContainer.style.display = 'block'; 
                setTimeout(() => { 
                    quizContainer.classList.add('visible');
                }, 10); 

                summaryContainer.style.display = 'none';
                quizCardContent.style.transition = 'none';
                quizCardContent.style.transform = 'translateX(0)';
                quizCardContent.style.opacity = '0';
                loadQuestion(0);
                setTimeout(() => {
                    quizCardContent.style.transition = 'opacity 0.35s ease-in-out'; 
                    quizCardContent.style.opacity = '1';
                }, 50); 
            } else {
                mainHeader.style.display = 'block'; 
            }
        });

        nextButton.addEventListener('click', () => {
            if (currentQuestionIndex < quizQuestions.length - 1 && !nextButton.disabled) {
                animateAndLoadQuestion(currentQuestionIndex + 1, 'next');
            }
        });

        prevButton.addEventListener('click', () => {
            if (currentQuestionIndex > 0 && !prevButton.disabled) {
                animateAndLoadQuestion(currentQuestionIndex - 1, 'prev');
            }
        });

        finishButton.addEventListener('click', () => {
            showSummary(); 
        });

        restartButton.addEventListener('click', () => {
            resetQuizState();
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'block'; 
            summaryContainer.style.display = 'none';
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                quizContainer.style.display = 'none';
            }, 500);
            categorySelectContainer.style.display = 'block';
        });

        backToMenuButton.addEventListener('click', (e) => {
            e.preventDefault(); 
            resetQuizState();
            reviewSourceQuestions = []; 
            mainHeader.style.display = 'block'; 
            quizContainer.classList.remove('visible');
            setTimeout(() => {
                quizContainer.style.display = 'none';
            }, 500);
            summaryContainer.style.display = 'none';
            categorySelectContainer.style.display = 'block';
        });

        reviewIncorrectBtn.addEventListener('click', () => {
            const selectedReviewMode = document.querySelector('input[name="review-answer-mode"]:checked').value;
            startReviewQuiz(selectedReviewMode);
        });

        document.addEventListener('DOMContentLoaded', () => {
            populateCategories();
            updateNumQuestionsOptions();
            categorySelectContainer.style.display = 'block'; 
            quizContainer.style.display = 'none'; 
            quizContainer.classList.remove('visible');
            summaryContainer.style.display = 'none'; 
            mainHeader.style.display = 'block'; 
        });

    </script>
</body>
</html>
